<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üöç BuS..MarG..</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #667eea;
      --primary-dark: #4f46e5;
      --secondary: #764ba2;
      --accent: #06b6d4;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #000000;
      --darker: #000000;
      --light: #f8fafc;
      --gray: #64748b;
      --gray-light: #94a3b8;
      --glass: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.15);
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 20px 40px -5px rgba(0, 0, 0, 0.3);
    }
    
    html {
      overflow-x: hidden;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000000;
      min-height: 100vh;
      color: #f1f5f9;
      overflow-x: hidden;
      font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    
    .container {
      max-width: 100vw;
      width: 100%;
      margin: 0;
      background: linear-gradient(145deg, rgba(0, 0, 0, 0.95), rgba(10, 10, 10, 0.90));
      backdrop-filter: blur(20px);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    
    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: var(--glass);
      backdrop-filter: blur(15px);
      border-bottom: 1px solid var(--glass-border);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .nav-brand {
      font-weight: 700;
      font-size: 1.3rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .nav-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .driver-page-btn {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    
    .driver-page-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }
    
    .main-content {
      padding: 25px;
      max-width: 100%;
      overflow-x: hidden;
    }
    
    /* Clean User Location Card */
    .location-card {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .location-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .location-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .location-header h2 {
      color: #f8fafc;
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .location-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      border: 2px solid transparent;
    }
    
    .status-tracking {
      background: rgba(16, 185, 129, 0.15);
      border-color: rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    
    .status-stopped {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .location-map-container {
      width: 100%;
      height: 300px;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      background: var(--darker);
    }

    /* Hide the home preview map (moved out of header for cleaner UI on Android) */
    .location-map-container { display: none !important; }
    
    .location-map {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* Enhanced Auth Modal */
    .auth-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      animation: modalFadeIn 0.3s ease;
    }
    
    .auth-modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, rgba(0, 0, 0, 0.95), rgba(10, 10, 10, 0.90));
      backdrop-filter: blur(20px);
      border-radius: 25px;
      padding: 40px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-lg);
      width: 90%;
      max-width: 450px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .auth-modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
    }
    
    .close-auth {
      position: absolute;
      top: 15px;
      right: 20px;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .auth-header {
      text-align: center;
      margin-bottom: 30px;
      margin-top: 20px;
    }
    
    .auth-header h2 {
      font-size: 1.8rem;
      font-weight: 700;
      color: #f8fafc;
      margin-bottom: 8px;
    }
    
    .auth-header p {
      color: var(--gray-light);
      font-size: 1rem;
    }
    
    .auth-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      background: rgba(15, 23, 42, 0.6);
      padding: 4px;
      border-radius: 12px;
    }
    
    .auth-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--gray-light);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }
    
    .auth-tab.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #e2e8f0;
      font-size: 0.95rem;
    }
    
    .form-input {
      width: 100%;
      padding: 14px 16px;
      padding-left: 45px;
      border: 2px solid var(--glass-border);
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: var(--glass);
      color: #f8fafc;
      backdrop-filter: blur(10px);
      font-family: inherit;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      background: rgba(255, 255, 255, 0.05);
    }
    
    .form-input::placeholder {
      color: var(--gray-light);
    }
    
    .input-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-light);
      font-size: 1rem;
      margin-top: 14px;
    }
    
    .password-toggle {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-light);
      cursor: pointer;
      font-size: 1rem;
      margin-top: 14px;
      transition: color 0.3s ease;
    }
    
    .password-toggle:hover {
      color: var(--primary);
    }
    
    .btn {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-decoration: none;
      margin: 4px 4px 4px 0;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
      font-family: inherit;
      width: 100%;
      max-width: 100%;
      word-break: break-word;
      position: relative;
      overflow: hidden;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      cursor: not-allowed;
      transform: none;
      opacity: 0.6;
    }
    
    .btn-secondary {
      background: transparent;
      border: 2px solid var(--glass-border);
      color: var(--gray-light);
      box-shadow: none;
    }
    
    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .btn-google {
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
      border: none;
      margin-top: 10px;
    }
    
    .btn-google:hover {
      background: linear-gradient(135deg, #3367d6, #2d8f47);
    }
    
    .divider {
      display: flex;
      align-items: center;
      margin: 25px 0;
      color: var(--gray-light);
      font-size: 0.9rem;
    }
    
    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--glass-border);
    }
    
    .divider span {
      padding: 0 15px;
      background: var(--glass);
      border-radius: 20px;
    }
    
    .error-message {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--danger);
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      display: none;
    }
    
    .success-message {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--success);
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      display: none;
    }
    
    .loading-spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Driver Registration Section */
    .card {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      max-width: 100%;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .card h2 {
      color: #f8fafc;
      margin-bottom: 20px;
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .profile-pic-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 0 auto 20px auto;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      padding: 3px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .profile-pic-container:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }
    
    .profile-pic {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      background: var(--glass);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: white;
      position: relative;
      overflow: hidden;
    }
    
    .profile-pic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    
    .edit-profile-btn {
      position: absolute;
      bottom: -5px;
      right: -5px;
      width: 30px;
      height: 30px;
      background: var(--primary);
      border: 2px solid white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .edit-profile-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #e2e8f0;
      font-size: 0.95rem;
    }
    
    .input-group input, .input-group select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--glass-border);
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: var(--glass);
      color: #f8fafc;
      backdrop-filter: blur(10px);
      font-family: inherit;
      max-width: 100%;
    }
    
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .bus-category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
      max-height: 200px;
      overflow-y: auto;
      padding: 15px;
      background: var(--glass);
      border-radius: 16px;
      border: 1px solid var(--glass-border);
    }
    
    .category-btn {
      padding: 12px 8px;
      border: 2px solid var(--glass-border);
      background: var(--glass);
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      color: #cbd5e1;
    }
    
    .category-btn:hover, .category-btn.selected {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.15);
      color: var(--primary);
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 20px;
      border: 2px solid transparent;
    }
    
    .status-online {
      background: rgba(16, 185, 129, 0.15);
      border-color: rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    
    .status-offline {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .status-pending {
      background: rgba(245, 158, 11, 0.15);
      border-color: rgba(245, 158, 11, 0.3);
      color: #f59e0b;
    }
    
    .status-rejected {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .search-container {
      position: relative;
      margin-bottom: 20px;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 16px 12px 45px;
      border: 2px solid var(--glass-border);
      border-radius: 25px;
      background: var(--glass);
      color: #f8fafc;
      font-size: 1rem;
      transition: all 0.3s ease;
      font-family: inherit;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-light);
      font-size: 1rem;
    }
    
    .filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-tabs .btn {
      padding: 8px 16px;
      font-size: 0.9rem;
      border-radius: 20px;
      margin: 0;
      flex: 1;
      min-width: 80px;
      justify-content: center;
      background: #000;
      color: #fff;
    }
    
    .filter-tabs .btn.active {
      background: #000;
      color: #fff;
      transform: translateY(-1px);
    }
    
    .bus-list {
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
    }
    
    .bus-item {
      background: linear-gradient(135deg, var(--glass), rgba(255, 255, 255, 0.05));
      margin-bottom: 15px;
      padding: 20px;
      border-radius: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--glass-border);
      transition: all 0.3s ease;
      max-width: 100%;
      overflow: hidden;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .bus-item:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    
    .bus-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
      border-radius: 20px 20px 0 0;
    }
    
    .bus-info {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
      min-width: 0;
    }
    
    .bus-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
      border: 3px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .bus-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    
    .bus-avatar.live {
      border-color: var(--success);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
      50% { box-shadow: 0 0 30px rgba(16, 185, 129, 0.6); }
      100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
    }
    
    @keyframes pulse-glow {
      0% { 
        transform: scale(1);
        opacity: 0.8;
      }
      50% { 
        transform: scale(1.1);
        opacity: 1;
      }
      100% { 
        transform: scale(1);
        opacity: 0.8;
      }
    }
    
    @keyframes headlight-flicker {
      0%, 100% { 
        box-shadow: 
          0 0 20px rgba(255,255,136,0.8),
          0 0 40px rgba(255,255,136,0.4),
          inset 0 0 10px rgba(255,255,255,0.5);
      }
      50% { 
        box-shadow: 
          0 0 30px rgba(255,255,136,1),
          0 0 60px rgba(255,255,136,0.6),
          inset 0 0 15px rgba(255,255,255,0.8);
      }
    }
    
    @keyframes searchPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    .bus-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    
    /* 3D Bus Sticker Styles */
    .bus-3d-icon {
      background: transparent !important;
      border: none !important;
    }
    
    .bus-3d-sticker {
      pointer-events: none;
      user-select: none;
    }
    
    .bus-3d-sticker .bus-body {
      transition: all 0.3s ease;
    }
    
    .bus-3d-sticker:hover .bus-body {
      transform: scale(1.05);
    }

    /* Sticker Editor Styles */
    .sticker-option {
      transition: all 0.3s ease;
    }
    
    .sticker-option:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .sticker-option.selected {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    
    .bus-details {
      flex: 1;
      min-width: 0;
    }
    
    .bus-details h4 {
      margin-bottom: 6px;
      color: #f8fafc;
      font-size: 1.1rem;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .bus-details p {
      color: #cbd5e1;
      font-size: 0.85rem;
      margin: 3px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .bus-details p i {
      width: 12px;
      color: var(--primary);
    }
    
    .bus-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .follow-btn, .like-btn, .stop-btn {
      padding: 8px 14px;
      font-size: 0.8rem;
      border-radius: 10px;
      min-width: 70px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .stop-btn {
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      color: white;
      border: none;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }
    
    .stop-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }
    
    .follow-btn {
      background: linear-gradient(135deg, #e91e63, #ad1457);
    }
    
    .follow-btn.following {
      background: linear-gradient(135deg, var(--success), #059669);
    }
    
    .like-btn {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
    }
    
    .like-btn.liked {
      background: linear-gradient(135deg, #ff4757, #c44569);
    }
    
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray-light);
      font-size: 1rem;
    }
    
    .loading::after {
      content: '';
      display: inline-block;
      width: 25px;
      height: 25px;
      border: 3px solid rgba(99, 102, 241, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    
    .hidden {
      display: none !important;
    }
    
    .notification-popup {
      position: fixed;
      top: 80px;
      right: 20px;
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
      padding: 15px 20px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
      z-index: 3000;
      transform: translateX(400px);
      transition: all 0.4s ease;
      max-width: 300px;
      font-size: 0.9rem;
    }
    
    .notification-popup.show {
      transform: translateX(0);
    }
    
    .notification-popup.error {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    }
    
    .notification-popup.info {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }
    
    .admin-panel {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: 800;
      color: white;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Mobile Optimizations */
    @media (max-width: 768px) {
      .main-content {
        padding: 20px;
      }
      
      .bus-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        padding: 15px;
      }
      
      .bus-info {
        width: 100%;
      }
      
      .bus-actions {
        flex-direction: row;
        width: 100%;
        justify-content: space-around;
      }
      
      .follow-btn, .like-btn {
        flex: 1;
        margin: 0 5px;
      }
    }
    
    @media (max-width: 480px) {
      .main-content {
        padding: 15px;
      }
      
      .card {
        padding: 20px 15px;
        margin-bottom: 15px;
      }
      
      .btn {
        padding: 12px 20px;
        font-size: 0.95rem;
      }
    }
    
    /* Android-Friendly Enhancements */
    @media (max-width: 768px) {
      .container {
        padding: 8px;
        max-width: 100vw;
      }
      
      .card {
        margin-bottom: 12px;
        border-radius: 12px;
        padding: 15px;
      }
      
      .btn {
        padding: 12px 16px;
        font-size: 0.9rem;
        border-radius: 8px;
        min-height: 44px; /* Android touch target minimum */
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      
      .bus-item {
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 10px;
      }
      
      .bus-avatar {
        width: 45px;
        height: 45px;
        font-size: 18px;
        border-radius: 10px;
      }
      
      .bus-details h3 {
        font-size: 16px;
        margin-bottom: 4px;
      }
      
      .bus-details p {
        font-size: 13px;
        line-height: 1.4;
      }
      
      .filter-tabs {
        gap: 8px;
        margin-bottom: 15px;
      }
      
      .filter-tabs .btn {
        flex: 1;
        padding: 12px 8px;
        font-size: 0.85rem;
      }
      
      /* Passenger features grid */
      .passenger-features {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        margin-top: 15px;
      }
      
      .passenger-features .btn {
        padding: 10px 6px;
        font-size: 0.75rem;
        min-height: 60px;
        flex-direction: column;
        gap: 4px;
      }
      
      /* Admin panel mobile */
      .admin-panel .btn {
        padding: 10px 12px;
        font-size: 0.8rem;
        margin-bottom: 8px;
      }
      
      /* Modal improvements */
      .auth-modal-content {
        margin: 10px;
        max-height: calc(100vh - 20px);
        border-radius: 15px;
      }
      
      /* Map container mobile */
      #adminMapContainer {
        height: 60vh;
        border-radius: 12px;
      }
      
      /* Search input mobile */
      .search-input {
        padding: 12px 16px 12px 45px;
        font-size: 16px; /* Prevents zoom on iOS */
        border-radius: 10px;
      }
      
      /* Notification mobile */
      .notification-popup {
        left: 10px;
        right: 10px;
        border-radius: 10px;
        padding: 15px;
      }
    }
    
    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      .btn:hover {
        transform: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      
      .bus-item:hover {
        transform: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      }
      
      .btn:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }
    }
    
    /* High DPI displays */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .bus-avatar, .tracker-avatar {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
      }
    }
    
    /* Dark mode improvements for mobile */
    @media (prefers-color-scheme: dark) {
      .card {
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      
      .btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }
    }

    /* Spline Viewer Modifications */
    spline-viewer {
      --spline-background: #000000 !important;
    }

    spline-viewer [data-watermark] {
      display: none !important;
    }

    .spline-container {
      position: relative !important;
      padding-left: 40px !important;
      padding-right: 40px !important;
      background: #000000 !important;
    }

    @media (max-width: 768px) {
      spline-viewer [data-watermark] {
        display: none !important;
      }

      .spline-container {
        padding-left: 20px !important;
        padding-right: 20px !important;
      }

      /* AI Assistant Button Positioning for Android/Mobile */
      busmarg-ai + div {
        position: absolute !important;
        bottom: 10px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        right: auto !important;
        background: rgba(0, 0, 0, 0.8) !important;
      }
    }

  </style>
<script type="module" src="https://unpkg.com/@splinetool/viewer@1.10.77/build/spline-viewer.js"></script>
</head>
<body>
  <div class="container">
    <!-- Top Navigation with Driver Page Button -->
    <div class="top-nav">
      <div class="nav-brand">
        <i class="fas fa-bus"></i> üöç BuS..MarG..
      </div>
      <div class="nav-actions">
        <button class="driver-page-btn" onclick="openDriverPage()">
          <i class="fas fa-user-tie"></i> DRIVER PAGE
        </button>
        <button class="btn btn-danger hidden" id="logoutBtn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>

    <div class="main-content">
      <!-- Clean User Location Section -->
      <div class="location-card">
        <div class="location-header">
          <h2><i class="fas fa-map-marker-alt"></i> Your Location</h2>
          <div id="userLocationStatus" class="location-status status-stopped">
            <span>‚óè</span> Location Off
          </div>
        </div>

        <div class="location-map-container">
          <!-- Replaced Google iframe with lightweight Leaflet preview (mobile-friendly, no API key) -->
          <div id="userLocationMap" class="location-map" style="height:220px; border-radius:12px; overflow:hidden; background:var(--darker);"></div>
          <div style="position:absolute; right:18px; top:18px; display:flex; gap:8px; z-index:20;">
            <button id="refreshLocBtn" class="btn" style="padding:8px 10px; font-size:0.85rem;">Refresh</button>
            <button id="toggleAutoBtn" class="btn btn-secondary" style="padding:8px 10px; font-size:0.85rem;">Auto: Off</button>
            <button id="shareLocBtn" class="btn" style="padding:8px 10px; font-size:0.85rem;">Share</button>
          </div>
          <div style="position:absolute; left:18px; top:18px; z-index:20; color:var(--gray-light); font-size:0.85rem; background:rgba(0,0,0,0.25); padding:6px 10px; border-radius:8px;">Nearby: <span id="nearbyCount">0</span></div>
        </div>
      </div>

      <!-- 3D Spline Effect -->
      <div style="width: 100%; height: 300px; border-radius: 15px; overflow: hidden; margin-bottom: 20px; border: 1px solid var(--glass-border); background: var(--glass);">
        <spline-viewer url="https://prod.spline.design/fu6hFoKxIOITULsj/scene.splinecode"></spline-viewer>
      </div>

      <!-- Search and Filter -->
      <div class="card">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" class="search-input" id="busSearchInput" placeholder="Search buses..." onkeyup="searchBuses()">
        </div>
        <div class="filter-tabs">
          <button class="btn active" onclick="showLiveBuses()">
            <i class="fas fa-broadcast-tower"></i> Live
          </button>
          <button class="btn" onclick="showAllBuses()">
            <i class="fas fa-list"></i> All
          </button>
          <button class="btn" onclick="showNearbyBuses()">
            <i class="fas fa-map-marker-alt"></i> Nearby
          </button>
        </div>
        
        

      <!-- Bus List -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2><i class="fas fa-satellite"></i> <span id="busListTitle">Live Buses</span></h2>
          <div id="liveStatusIndicator" style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 20px; font-size: 0.8rem;">
            <div style="width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 1s infinite;"></div>
            <span style="color: var(--success); font-weight: 600;">LIVE</span>
          </div>
        </div>
        <div class="bus-list" id="busList"></div>
        <div id="noBuses" class="loading hidden">No buses available</div>
      </div>
    </div>
  </div>

  <!-- Enhanced Auth Modal -->
  <div id="authModal" class="auth-modal">
    <div class="auth-modal-content">
      <button class="close-auth" onclick="closeDriverPage()">&times;</button>
      
      <div class="auth-header">
        <h2>Driver & Admin Access</h2>
        <p>Secure login for drivers and administrators</p>
      </div>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('signin')">Sign In</button>
        <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
      </div>

      <!-- Error/Success Messages -->
      <div id="errorMessage" class="error-message"></div>
      <div id="successMessage" class="success-message"></div>

      <!-- Sign In Form -->
      <div id="signinForm" class="auth-form">
        <div class="form-group">
          <label for="signinEmail">Email Address</label>
          <i class="fas fa-envelope input-icon"></i>
          <input type="email" id="signinEmail" class="form-input" placeholder="Enter your email" required>
        </div>
        
        <div class="form-group">
          <label for="signinPassword">Password</label>
          <i class="fas fa-lock input-icon"></i>
          <input type="password" id="signinPassword" class="form-input" placeholder="Enter your password" required>
          <i class="fas fa-eye password-toggle" onclick="togglePassword('signinPassword')"></i>
        </div>

        <button class="btn" onclick="signInWithEmail()" id="signinBtn">
          <span>Sign In</span>
          <div class="loading-spinner" id="signinSpinner"></div>
        </button>
      </div>

      <!-- Sign Up Form -->
      <div id="signupForm" class="auth-form hidden">
        <div class="form-group">
          <label for="signupEmail">Email Address</label>
          <i class="fas fa-envelope input-icon"></i>
          <input type="email" id="signupEmail" class="form-input" placeholder="Enter your email" required>
        </div>
        
        <div class="form-group">
          <label for="signupPassword">Password</label>
          <i class="fas fa-lock input-icon"></i>
          <input type="password" id="signupPassword" class="form-input" placeholder="Create a strong password" required>
          <i class="fas fa-eye password-toggle" onclick="togglePassword('signupPassword')"></i>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm Password</label>
          <i class="fas fa-lock input-icon"></i>
          <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm your password" required>
          <i class="fas fa-eye password-toggle" onclick="togglePassword('confirmPassword')"></i>
        </div>

        <button class="btn" onclick="signUpWithEmail()" id="signupBtn">
          <span>Create Account</span>
          <div class="loading-spinner" id="signupSpinner"></div>
        </button>
      </div>

      <!-- Google Sign In -->
      <div class="divider">
        <span>or continue with</span>
      </div>

      <button class="btn btn-google" onclick="signInWithGoogle()">
        <img src="https://developers.google.com/identity/images/g-logo.png" width="20" height="20">
        <span>Google</span>
      </button>
    </div>
  </div>

  <!-- Driver Registration Section -->
  <div id="registrationSection" class="card hidden">
    <h2><i class="fas fa-user-plus"></i> Complete Your Driver Profile</h2>
    
    <div class="profile-pic-container" onclick="openProfileEditor()">
      <div class="profile-pic" id="profilePicPreview">
        <i class="fas fa-camera"></i>
      </div>
      <div class="edit-profile-btn">
        <i class="fas fa-edit"></i>
      </div>
    </div>
    <input type="file" id="profileImageInput" accept="image/*" onchange="handleProfileImageUpload(event)" style="display: none;">
    
    <div class="input-group">
      <label><i class="fas fa-user"></i> First Name *</label>
      <input type="text" id="firstName" placeholder="Enter first name" required>
    </div>
    <div class="input-group">
      <label><i class="fas fa-user"></i> Last Name *</label>
      <input type="text" id="lastName" placeholder="Enter last name" required>
    </div>
    <div class="input-group">
      <label><i class="fas fa-phone"></i> Mobile Number *</label>
      <input type="tel" id="mobileNumber" placeholder="10-digit mobile number" maxlength="10" required>
    </div>
    <div class="input-group">
      <label><i class="fas fa-bus"></i> Bus Category *</label>
      <div class="bus-category-grid" id="busCategoryGrid"></div>
      <button type="button" class="category-btn" onclick="selectLocal()" id="localBtn">Local</button>
    </div>
    <button class="btn btn-success" onclick="saveUserProfile()">
      <i class="fas fa-save"></i> Save & Request Access
    </button>
  </div>

  <!-- Tracker Modal (in-page) -->
  <div id="trackerModal" style="display:none; position:fixed; inset:0; z-index:4000; background:rgba(0,0,0,0.85);">
    <div style="position:absolute; left:12px; right:12px; top:12px; z-index:4015; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px; border-radius:10px; pointer-events:auto;">
      <div style="display:flex; align-items:center; gap:12px; background:rgba(15,23,42,0.9); padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.04);">
        <div id="trackerAvatar" style="width:48px;height:48px;border-radius:8px;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-size:20px">üöå</div>
        <div>
          <div id="trackerDriver" style="font-weight:700;font-size:16px;color:#fff">Driver</div>
          <div id="trackerBus" style="color:#cbd5e1;font-size:13px">Bus</div>
        </div>
        <button id="homeCloseCenterBtn" class="btn btn-secondary" style="padding:6px 12px; font-size:0.8rem; margin-left:8px;">
          <i class="fas fa-home"></i> Home Close Center
        </button>
      </div>
        <div style="display:flex;gap:8px;align-items:center">
        <div style="text-align:right; margin-right:8px; color:#cbd5e1; font-size:13px">
          <div id="trackerSpeed">Speed: 0 km/h</div>
          <div id="trackerDistance">Distance: 0.0 km</div>
        </div>
        <button id="toggleLabelBtn" class="btn btn-secondary" title="Toggle marker label">Show Label</button>
        <button id="trackerCenterBtn" class="btn">Center</button>
        <button id="trackerHomeBtn" class="btn btn-secondary">Home</button>
        <button id="trackerSelfTrackBtn" class="btn" style="background:linear-gradient(135deg,#06b6d4,#0ea5b0);display:none;">Track Self</button>
        <button id="trackerCloseBtn" class="btn btn-danger">Close</button>
      </div>
    </div>
  <!-- push the map down so header controls remain visible and tappable on Android -->
  <div id="trackerMap" style="position:absolute;left:0;right:0;top:72px;bottom:0;z-index:4005;">
      <!-- map injected here -->
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminSection" class="hidden">
    <div class="admin-panel">
      <h2><i class="fas fa-crown"></i> Admin Panel</h2>
      
      <div class="stats-grid" id="adminStats">
        <div class="stat-card">
          <div class="stat-number" id="totalDrivers">0</div>
          <div class="stat-label">Drivers</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingRequests">0</div>
          <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="activeBuses">0</div>
          <div class="stat-label">Live</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalFollows">0</div>
          <div class="stat-label">Follows</div>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn" onclick="loadPendingRequests()" style="background: rgba(255,255,255,0.2); color: white;">
          <i class="fas fa-sync-alt"></i> Requests
        </button>
        <button class="btn" onclick="showAllBusesAdmin()" style="background: rgba(255,255,255,0.2); color: white;">
          <i class="fas fa-users-cog"></i> Manage
        </button>
        <button class="btn" onclick="openAdminMapEditor()" style="background: rgba(255,255,255,0.2); color: white;">
          <i class="fas fa-map-marked-alt"></i> Map Editor
        </button>
        <button class="btn" onclick="openSystemAnalytics()" style="background: rgba(255,255,255,0.2); color: white;">
          <i class="fas fa-chart-bar"></i> Analytics
        </button>
        <button class="btn" onclick="openEmergencySystem()" style="background: rgba(255,255,255,0.2); color: white;">
          <i class="fas fa-exclamation-triangle"></i> Emergency
        </button>
        <button class="btn" onclick="openMaintenanceMode()" style="background: rgba(255,255,255,0.2); color: white;">
          <i class="fas fa-tools"></i> Maintenance
        </button>
        <button class="btn" onclick="openBroadcastSystem()" style="background: rgba(255,255,255,0.2); color: white;">
          <i class="fas fa-bullhorn"></i> Broadcast
        </button>
        <button class="btn" onclick="openBackupSystem()" style="background: rgba(255,255,255,0.2); color: white;">
          <i class="fas fa-database"></i> Backup
        </button>
      </div>
      
      <div id="pendingRequests" class="loading hidden">Loading...</div>
    </div>
  </div>

  <!-- Driver Panel -->
  <div id="driverPanel" class="card hidden">
    <h2><i class="fas fa-tachometer-alt"></i> Driver Dashboard</h2>
    <div id="driverStatus" class="status-badge status-offline">
      <span>‚óè</span> Status: Offline
    </div>
    <div id="userInfo" style="margin-bottom: 20px; padding: 20px; background: var(--glass); border-radius: 15px;"></div>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <button id="startStopBtn" class="btn btn-success" onclick="toggleGPS()">
        <i class="fas fa-rocket"></i> Start Tracking
      </button>
      <button class="btn" onclick="showMyStats()">
        <i class="fas fa-chart-line"></i> Analytics
      </button>
    </div>
  </div>

  <!-- Admin Map Editor Modal -->
  <div id="adminMapModal" class="auth-modal" style="display:none;">
    <div class="auth-modal-content" style="max-width: 95vw; max-height: 95vh; width: 98vw; height: 95vh;">
      <button class="close-auth" onclick="closeAdminMapEditor()">&times;</button>
      
      <div class="auth-header">
        <h2><i class="fas fa-map-marked-alt"></i> Admin Map Editor</h2>
        <p>Edit landmarks, bus stops, routes, and bus stickers</p>
      </div>

      <!-- Search Bar -->
      <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
        <div style="flex: 1; position: relative;">
          <input type="text" id="mapSearchInput" placeholder="Search for addresses, places..." 
                 style="width: 100%; padding: 12px 16px 12px 45px; border: 2px solid var(--glass-border); border-radius: 25px; background: var(--glass); color: #f8fafc; font-size: 1rem; font-family: inherit; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <div style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </div>
        </div>
        <button class="btn" onclick="searchOnMap()" style="background: rgba(6, 182, 212, 0.8); padding: 12px 20px; border-radius: 25px; box-shadow: 0 2px 10px rgba(6, 182, 212, 0.3);">
          <i class="fas fa-search"></i> Search
        </button>
      </div>

      <!-- Control Buttons -->
      <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
        <button class="btn" onclick="addBusStop()" style="background: rgba(99, 102, 241, 0.8);">
          <i class="fas fa-bus"></i> Add Bus Stop
        </button>
        <button class="btn" onclick="addRoadHighlight()" style="background: rgba(245, 158, 11, 0.8);">
          <i class="fas fa-route"></i> Highlight Road
        </button>
        <!-- Bus Stickers button removed -->
        <button class="btn" onclick="openAdminManager()" style="background: rgba(168, 85, 247, 0.8);">
          <i class="fas fa-users-cog"></i> Admin Access
        </button>
        <button class="btn" onclick="saveMapChanges()" style="background: rgba(239, 68, 68, 0.8);">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </div>

      <!-- Map Container -->
      <div id="adminMapContainer" style="width: 100%; height: 70vh; border-radius: 15px; overflow: hidden; background: var(--darker); position: relative;">
        <!-- Map will be injected here -->
      </div>

      <div id="mapEditorInfo" style="margin-top: 15px; padding: 15px; background: var(--glass); border-radius: 10px; font-size: 0.9rem; color: var(--gray-light);">
  <strong>Instructions:</strong> Search for locations, click on the map to add landmarks/bus stops/routes.
      </div>
    </div>
  </div>

  <!-- Bus Sticker Editor Modal Removed -->

  <!-- Admin Access Management Modal -->
  <div id="adminAccessModal" class="auth-modal" style="display:none;">
    <div class="auth-modal-content" style="max-width: 90vw; max-height: 90vh;">
      <button class="close-auth" onclick="closeAdminManager()">&times;</button>
      
      <div class="auth-header">
        <h2><i class="fas fa-users-cog"></i> Admin Access Management</h2>
        <p>Manage admin access like WhatsApp group administration</p>
      </div>

      <!-- Add New Admin -->
      <div style="background: var(--glass); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
        <h3 style="color: #f8fafc; margin-bottom: 15px;"><i class="fas fa-user-plus"></i> Add New Admin</h3>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <input type="email" id="newAdminEmail" placeholder="Enter admin email address" 
                 style="flex: 1; min-width: 250px; padding: 12px 16px; border: 2px solid var(--glass-border); border-radius: 10px; background: var(--glass); color: #f8fafc; font-family: inherit;">
          <button class="btn" onclick="addNewAdmin()" style="background: rgba(16, 185, 129, 0.8);">
            <i class="fas fa-plus"></i> Add Admin
          </button>
        </div>
      </div>

      <!-- Current Admins List -->
      <div style="background: var(--glass); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
        <h3 style="color: #f8fafc; margin-bottom: 15px;"><i class="fas fa-crown"></i> Current Admins</h3>
        <div id="adminsList" style="max-height: 300px; overflow-y: auto;">
          <!-- Admins will be listed here -->
        </div>
      </div>

      <div style="display: flex; gap: 10px; justify-content: center;">
        <button class="btn btn-secondary" onclick="closeAdminManager()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <!-- Road Highlighting Modal -->
  <div id="roadHighlightModal" class="auth-modal" style="display:none;">
    <div class="auth-modal-content" style="max-width: 80vw; max-height: 80vh;">
      <button class="close-auth" onclick="closeRoadHighlight()">&times;</button>
      
      <div class="auth-header">
        <h2><i class="fas fa-route"></i> Road Highlighting System</h2>
        <p>Highlight roads between cities with automatic routing</p>
      </div>

      <!-- Route Input -->
      <div style="background: var(--glass); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
        <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 8px; color: #e2e8f0; font-weight: 600;">Starting City</label>
            <input type="text" id="startCity" placeholder="Enter starting city name" 
                   style="width: 100%; padding: 12px 16px; border: 2px solid var(--glass-border); border-radius: 10px; background: var(--glass); color: #f8fafc; font-family: inherit;">
          </div>
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 8px; color: #e2e8f0; font-weight: 600;">Destination City</label>
            <input type="text" id="destCity" placeholder="Enter destination city name" 
                   style="width: 100%; padding: 12px 16px; border: 2px solid var(--glass-border); border-radius: 10px; background: var(--glass); color: #f8fafc; font-family: inherit;">
          </div>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn" onclick="highlightRoute()" style="background: rgba(16, 185, 129, 0.8);">
            <i class="fas fa-route"></i> Highlight Route
          </button>
          <button class="btn" onclick="clearHighlights()" style="background: rgba(239, 68, 68, 0.8);">
            <i class="fas fa-trash"></i> Clear All
          </button>
        </div>
      </div>

      <!-- Existing Highlights -->
      <div style="background: var(--glass); padding: 20px; border-radius: 15px;">
        <h3 style="color: #f8fafc; margin-bottom: 15px;"><i class="fas fa-list"></i> Existing Road Highlights</h3>
        <div id="highlightsList" style="max-height: 200px; overflow-y: auto;">
          <!-- Highlights will be listed here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Popup -->
  <div id="notificationPopup" class="notification-popup">
    <div id="notificationText"></div>
  </div>

  <script type="module">
    // Firebase Configuration
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
      getAuth, 
      GoogleAuthProvider, 
      signInWithPopup, 
      signInWithRedirect,
      getRedirectResult,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut, 
      onAuthStateChanged,
      deleteUser
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { getDatabase, ref as dbRef, set, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

   // For Firebase JS SDK v7.20.0 and later, measurementId is optional

//TO-DO : Here put your own firebase config here
//const firebaseConfig = {
  //apiKey: "",
  //authDomain: "",
  //databaseURL: "",
  //projectId: "",
  //storageBucket: "",
  //messagingSenderId: "",
  //appId: "",
  //measurementId: ""
//};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();
    const rtdb = getDatabase(app);

    const ADMIN_EMAIL = "admin-email@example.com";
    
    // Global variables
    let currentUser = null;
    let userLocationInterval = null;
    let gpsInterval = null;
    let currentUserPosition = null;
    let userMapUrl = '';
    let followedBuses = new Set();
    let likedBuses = new Set();
    let allBusesData = [];
    let rtdbListener = null;
    let selectedBusCategory = null;
    let profileImageUrl = null;

    // Load local preferences
    function loadLocalPreferences() {
      const followed = localStorage.getItem('followedBuses');
      const liked = localStorage.getItem('likedBuses');
      
      if (followed) {
        followedBuses = new Set(JSON.parse(followed));
      }
      
      if (liked) {
        likedBuses = new Set(JSON.parse(liked));
      }
    }

    function saveLocalPreferences() {
      localStorage.setItem('followedBuses', JSON.stringify(Array.from(followedBuses)));
      localStorage.setItem('likedBuses', JSON.stringify(Array.from(likedBuses)));
    }

    // Enhanced notification system
    function showNotification(message, type = 'info', duration = 4000) {
      const popup = document.getElementById('notificationPopup');
      const text = document.getElementById('notificationText');
      
      text.innerHTML = message;
      popup.className = `notification-popup ${type}`;
      popup.classList.add('show');
      
      setTimeout(() => {
        popup.classList.remove('show');
      }, duration);
    }

    // Auth Modal Functions
    window.openDriverPage = function() {
      document.getElementById('authModal').style.display = 'block';
    };

    window.closeDriverPage = function() {
      document.getElementById('authModal').style.display = 'none';
    };

    // Show/Hide error messages
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 5000);
    }

    function hideMessages() {
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';
    }

    // Toggle loading state
    function toggleLoading(buttonId, spinnerId, isLoading) {
      const button = document.getElementById(buttonId);
      const spinner = document.getElementById(spinnerId);
      const span = button.querySelector('span');
      
      if (isLoading) {
        button.disabled = true;
        span.style.opacity = '0.7';
        spinner.style.display = 'inline-block';
      } else {
        button.disabled = false;
        span.style.opacity = '1';
        spinner.style.display = 'none';
      }
    }

    // Auth tab switching
    window.switchAuthTab = function(tab) {
      hideMessages();
      
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      if (tab === 'signin') {
        document.getElementById('signinForm').classList.remove('hidden');
        document.getElementById('signupForm').classList.add('hidden');
      } else if (tab === 'signup') {
        document.getElementById('signinForm').classList.add('hidden');
        document.getElementById('signupForm').classList.remove('hidden');
      }
    };

    // Password visibility toggle
    window.togglePassword = function(inputId) {
      const input = document.getElementById(inputId);
      const icon = input.nextElementSibling;
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    };

    // Email/Password Sign In
    window.signInWithEmail = async function() {
      const email = document.getElementById('signinEmail').value.trim();
      const password = document.getElementById('signinPassword').value;
      
      if (!email || !password) {
        showError('Please fill in all fields');
        return;
      }
      
      hideMessages();
      toggleLoading('signinBtn', 'signinSpinner', true);
      
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;
        showNotification('‚úÖ Signed in successfully!', 'success');
        closeDriverPage();
        
        // Clear form
        document.getElementById('signinEmail').value = '';
        document.getElementById('signinPassword').value = '';
        
      } catch (error) {
        console.error('Email sign in error:', error);
        let errorMessage = 'Sign in failed';
        
        switch (error.code) {
          case 'auth/user-not-found':
            errorMessage = 'No account found with this email';
            break;
          case 'auth/wrong-password':
            errorMessage = 'Incorrect password';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email address';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Too many failed attempts. Try again later';
            break;
          case 'auth/operation-not-allowed':
            errorMessage = 'Email/Password sign-in is not enabled. Please enable it in Firebase Console ‚Üí Authentication ‚Üí Sign-in Methods';
            break;
          default:
            errorMessage = error.message;
        }
        
        showError(errorMessage);
      } finally {
        toggleLoading('signinBtn', 'signinSpinner', false);
      }
    };

    // Email/Password Sign Up
    window.signUpWithEmail = async function() {
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (!email || !password || !confirmPassword) {
        showError('Please fill in all fields');
        return;
      }
      
      if (password.length < 6) {
        showError('Password must be at least 6 characters');
        return;
      }
      
      if (password !== confirmPassword) {
        showError('Passwords do not match');
        return;
      }
      
      hideMessages();
      toggleLoading('signupBtn', 'signupSpinner', true);
      
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;
        
        showNotification('‚úÖ Account created successfully!', 'success');
        closeDriverPage();
        
        // Clear form
        document.getElementById('signupEmail').value = '';
        document.getElementById('signupPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
      } catch (error) {
        console.error('Email sign up error:', error);
        let errorMessage = 'Account creation failed';
        
        switch (error.code) {
          case 'auth/email-already-in-use':
            errorMessage = 'An account with this email already exists';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email address';
            break;
          case 'auth/weak-password':
            errorMessage = 'Password is too weak';
            break;
          case 'auth/operation-not-allowed':
            errorMessage = 'Email/Password sign-up is not enabled. Please enable it in Firebase Console ‚Üí Authentication ‚Üí Sign-in Methods';
            break;
          default:
            errorMessage = error.message;
        }
        
        showError(errorMessage);
      } finally {
        toggleLoading('signupBtn', 'signupSpinner', false);
      }
    };

    // Google Sign In
    window.signInWithGoogle = async function() {
      hideMessages();
      
      try {
        provider.addScope('email');
        provider.addScope('profile');
        
        let result;
        
        try {
          result = await signInWithPopup(auth, provider);
        } catch (popupError) {
          console.warn('Popup failed, trying redirect:', popupError);
          
          if (popupError.code === 'auth/popup-blocked' || 
              popupError.code === 'auth/popup-closed-by-user' ||
              popupError.code === 'auth/cancelled-popup-request') {
            
            await signInWithRedirect(auth, provider);
            return;
          }
          
          throw popupError;
        }
        
        if (result && result.user) {
          currentUser = result.user;
          showNotification('‚úÖ Google sign-in successful!', 'success');
          closeDriverPage();
        }
        
      } catch (error) {
        console.error('Google sign in error:', error);
        let errorMessage = 'Google sign-in failed';
        
        switch (error.code) {
          case 'auth/account-exists-with-different-credential':
            errorMessage = 'Account exists with different sign-in method';
            break;
          case 'auth/popup-blocked':
            errorMessage = 'Popup blocked. Please allow popups for this site';
            break;
          case 'auth/popup-closed-by-user':
            errorMessage = 'Sign-in cancelled';
            break;
          case 'auth/operation-not-allowed':
            errorMessage = 'Google sign-in is not enabled. Please enable it in Firebase Console ‚Üí Authentication ‚Üí Sign-in Methods';
            break;
          default:
            errorMessage = error.message;
        }
        
        showError(errorMessage);
      }
    };

    // Automatic User Location Tracking
    function startAutoLocationTracking() {
      if (!navigator.geolocation) {
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          currentUserPosition = position.coords;
          updateUserLocationDisplay();
          
          document.getElementById('userLocationStatus').innerHTML = '<span>‚óè</span> Location On';
          document.getElementById('userLocationStatus').className = 'location-status status-tracking';
          
          // Start continuous tracking every 5 seconds
          userLocationInterval = setInterval(updateUserLocation, 5000);
        },
        (error) => {
          console.warn('Location access denied:', error);
        },
        { 
          enableHighAccuracy: true, 
          timeout: 10000, 
          maximumAge: 300000 
        }
      );
    }

    function updateUserLocation() {
      if (!navigator.geolocation) return;

      navigator.geolocation.getCurrentPosition(
        (position) => {
          currentUserPosition = position.coords;
          updateUserLocationDisplay();
        },
        (error) => {
          console.warn('Location update error:', error);
        },
        { 
          enableHighAccuracy: true, 
          timeout: 8000, 
          maximumAge: 2000 
        }
      );
    }

    function updateUserLocationDisplay() {
      if (!currentUserPosition) return;

      const lat = currentUserPosition.latitude.toFixed(6);
      const lng = currentUserPosition.longitude.toFixed(6);

      // Update map with smooth transition
      const newMapUrl = `https://maps.google.com/maps?q=${lat},${lng}&z=16&output=embed&t=roadmap`;
      if (userMapUrl !== newMapUrl) {
        userMapUrl = newMapUrl;
        document.getElementById('userLocationMap').src = newMapUrl;
      }
    }

    // Driver Registration Functions
    function generateBusCategoryGrid() {
      const grid = document.getElementById('busCategoryGrid');
      for (let i = 1; i <= 100; i++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'category-btn';
        btn.textContent = i;
        btn.onclick = () => selectCategory(i);
        grid.appendChild(btn);
      }
    }

    window.openProfileEditor = function() {
      document.getElementById('profileImageInput').click();
    };

    window.handleProfileImageUpload = function(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        showNotification('‚ùå Image too large (max 5MB)', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('profilePicPreview');
        preview.innerHTML = `<img src="${e.target.result}" alt="Profile">`;
        profileImageUrl = e.target.result;
      };
      reader.readAsDataURL(file);
    };

    window.selectCategory = function(number) {
      document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('selected'));
      event.target.classList.add('selected');
      selectedBusCategory = number.toString();
    };

    window.selectLocal = function() {
      document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('localBtn').classList.add('selected');
      selectedBusCategory = 'Local';
    };

    window.saveUserProfile = async function() {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const mobileNumber = document.getElementById('mobileNumber').value.trim();

      if (!firstName || !lastName || !mobileNumber || !selectedBusCategory) {
        showNotification('‚ùå Please fill all fields', 'error');
        return;
      }

      if (!/^\d{10}$/.test(mobileNumber)) {
        showNotification('‚ùå Invalid mobile number', 'error');
        return;
      }

      try {
        // Upload profile image if selected
        let finalProfileImageUrl = null;
        if (profileImageUrl && profileImageUrl.startsWith('data:')) {
          const response = await fetch(profileImageUrl);
          const blob = await response.blob();
          const imageRef = storageRef(storage, `profile_images/${currentUser.uid}`);
          await uploadBytes(imageRef, blob);
          finalProfileImageUrl = await getDownloadURL(imageRef);
        }

        await setDoc(doc(db, 'users', currentUser.uid), {
          uid: currentUser.uid,
          email: currentUser.email,
          firstName,
          lastName,
          mobileNumber,
          busCategory: selectedBusCategory,
          profileImage: finalProfileImageUrl,
          isApproved: false,
          isRejected: false,
          requestDate: serverTimestamp(),
          profileCompleted: true
        });

        showNotification('‚úÖ Profile saved! Awaiting admin approval.', 'success');
        checkUserStatus();
      } catch (error) {
        console.error('Profile save error:', error);
        showNotification('‚ùå Failed to save profile', 'error');
      }
    };

    // User Status Management
    async function checkUserStatus() {
      if (!currentUser) return;

      const userDoc = await getDocs(query(collection(db, 'users'), where('uid', '==', currentUser.uid)));
      
      if (userDoc.empty) {
        showRegistrationForm();
        return;
      }

      const userData = userDoc.docs[0].data();
      
      if (currentUser.email === ADMIN_EMAIL) {
        showAdminPanel();
      } else if (userData.isRejected) {
        await handleRejectedUser();
      } else if (userData.isApproved) {
        showDriverPanel(userData);
      } else {
        showPendingStatus(userData);
      }
    }

    // Handle Rejected User - Auto Delete Account
    async function handleRejectedUser() {
      try {
        showNotification('‚ùå Your account has been rejected by admin. Account will be deleted.', 'error', 6000);
        
        // Delete user data from Firestore
        await deleteDoc(doc(db, 'users', currentUser.uid));
        
        // Delete profile image from Storage if exists
        try {
          const imageRef = storageRef(storage, `profile_images/${currentUser.uid}`);
          await deleteObject(imageRef);
        } catch (e) {
          console.warn('No profile image to delete');
        }
        
        // Delete from RTDB if exists
        try {
          const locRef = dbRef(rtdb, `locations/${currentUser.uid}`);
          await remove(locRef);
        } catch (e) {
          console.warn('No RTDB data to delete');
        }
        
        // Clear local storage
        localStorage.removeItem('followedBuses');
        localStorage.removeItem('likedBuses');
        
        // Delete Firebase Auth user
        await deleteUser(currentUser);
        
        showNotification('üóëÔ∏è Account deleted successfully', 'info');
        
        // Reset UI
        setTimeout(() => {
          location.reload();
        }, 2000);
        
      } catch (error) {
        console.error('Error deleting rejected user:', error);
        showNotification('‚ùå Error deleting account. Please contact admin.', 'error');
      }
    }

    function showRegistrationForm() {
      hideAllSections();
      document.getElementById('registrationSection').classList.remove('hidden');
      generateBusCategoryGrid();
      showLogoutBtn();
    }

    function showAdminPanel() {
      hideAllSections();
      document.getElementById('adminSection').classList.remove('hidden');
      loadAdminStats();
      loadPendingRequests();
      showLogoutBtn();
    }

    function showDriverPanel(userData) {
      hideAllSections();
      document.getElementById('driverPanel').classList.remove('hidden');
      document.getElementById('userInfo').innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px;">
          <div class="bus-avatar">
            ${userData.profileImage ? `<img src="${userData.profileImage}" alt="Profile">` : 'üë§'}
          </div>
          <div style="flex: 1;">
            <h4 style="color: #f8fafc; margin-bottom: 5px; font-size: 1.2rem;">${userData.firstName} ${userData.lastName}</h4>
            <p style="color: #cbd5e1; margin: 2px 0;"><i class="fas fa-bus"></i> Bus: ${userData.busCategory}</p>
            <p style="color: var(--success); font-weight: 600;"><i class="fas fa-check-circle"></i> Approved</p>
          </div>
        </div>
      `;
      
      showLogoutBtn();
    }

    function showPendingStatus(userData) {
      hideAllSections();
      document.getElementById('driverPanel').classList.remove('hidden');
      document.getElementById('driverStatus').innerHTML = '<span>‚óè</span> Status: Pending';
      document.getElementById('driverStatus').className = 'status-badge status-pending';
      document.getElementById('userInfo').innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px;">
          <div class="bus-avatar">
            ${userData.profileImage ? `<img src="${userData.profileImage}" alt="Profile">` : 'üë§'}
          </div>
          <div style="flex: 1;">
            <h4 style="color: #f8fafc; margin-bottom: 5px; font-size: 1.2rem;">${userData.firstName} ${userData.lastName}</h4>
            <p style="color: #cbd5e1; margin: 2px 0;"><i class="fas fa-bus"></i> Bus: ${userData.busCategory}</p>
            <p style="color: var(--warning); font-weight: 600;"><i class="fas fa-clock"></i> Awaiting Approval</p>
          </div>
        </div>
      `;
      document.getElementById('startStopBtn').textContent = '‚è≥ Pending';
      document.getElementById('startStopBtn').disabled = true;
      showLogoutBtn();
    }

    function hideAllSections() {
      document.getElementById('registrationSection').classList.add('hidden');
      document.getElementById('adminSection').classList.add('hidden');
      document.getElementById('driverPanel').classList.add('hidden');
    }

    function showLogoutBtn() {
      document.getElementById('logoutBtn').classList.remove('hidden');
    }

    // GPS Tracking for Approved Drivers
    window.toggleGPS = async function() {
      if (gpsInterval) {
        stopGPSUpdates();
      } else {
        const hasPermission = await requestLocationPermission();
        if (hasPermission) {
          startGPSUpdates();
        }
      }
    };

    async function requestLocationPermission() {
      if (!navigator.geolocation) {
        showNotification('‚ùå Location not supported', 'error');
        return false;
      }

      return new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            showNotification('‚úÖ Location access granted', 'success');
            resolve(true);
          },
          (error) => {
            let message = '‚ùå Location access denied';
            if (error.code === 1) {
              message = '‚ùå Location blocked. Enable in browser settings.';
            }
            showNotification(message, 'error', 5000);
            resolve(false);
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
        );
      });
    }

    function startGPSUpdates() {
      document.getElementById('driverStatus').innerHTML = '<span>‚óè</span> Status: Live Tracking';
      document.getElementById('driverStatus').className = 'status-badge status-online';
      document.getElementById('startStopBtn').innerHTML = '<i class="fas fa-stop"></i> Stop Live Tracking';
      document.getElementById('startStopBtn').className = 'btn btn-danger';

      getUserData().then(userData => {
        // Initial location update
        updateGPSLocation(userData);
        
        // Real-time updates every 2 seconds for live tracking
        gpsInterval = setInterval(async () => {
          await updateGPSLocation(userData);
        }, 2000);
        
        // Also use watchPosition for continuous updates
        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(
            async (position) => {
              await updateGPSLocationWithPosition(userData, position);
            },
            (error) => {
              console.warn('Watch position error:', error);
            },
            {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 1000 // Accept cached position up to 1 second old
            }
          );
        }
      });

      showNotification('üöÄ Live tracking started! Real-time updates active', 'success');
    }

    async function updateGPSLocation(userData) {
      if (!currentUser) return;

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          await updateGPSLocationWithPosition(userData, pos);
        },
        (error) => {
          console.error('GPS error:', error);
        },
        { 
          enableHighAccuracy: true, 
          timeout: 5000, 
          maximumAge: 1000 // Accept cached position up to 1 second old
        }
      );
    }

    async function updateGPSLocationWithPosition(userData, pos) {
      if (!currentUser) return;

          try {
            const locRef = dbRef(rtdb, `locations/${currentUser.uid}`);
        const now = new Date();
            const payload = {
              uid: currentUser.uid,
              driverName: `${userData.firstName} ${userData.lastName}`,
              busCategory: userData.busCategory || 'Unknown',
              profileImage: userData.profileImage || null,
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              speed: pos.coords.speed || 0,
              heading: pos.coords.heading || 0,
              accuracy: pos.coords.accuracy || 0,
          altitude: pos.coords.altitude || 0,
          altitudeAccuracy: pos.coords.altitudeAccuracy || 0,
          lastUpdate: now.toLocaleString(),
          lastUpdateTime: now.toISOString(),
          timestamp: Date.now(),
          isLive: true,
          updateCount: (userData.updateCount || 0) + 1
        };

        // Use set with priority for real-time updates
            await set(locRef, payload);
        
        // Update user data with new update count
        if (userData.updateCount !== undefined) {
          userData.updateCount++;
        }
        
        console.log(`üìç Live location updated: ${pos.coords.latitude}, ${pos.coords.longitude} (${pos.coords.accuracy}m accuracy)`);
          } catch (error) {
            console.error('GPS update error:', error);
          }
    }

    function stopGPSUpdates() {
      if (gpsInterval) {
        clearInterval(gpsInterval);
        gpsInterval = null;
        
        try {
          const locRef = dbRef(rtdb, `locations/${currentUser.uid}`);
          remove(locRef).catch(console.error);
        } catch (e) { console.warn(e); }

        document.getElementById('driverStatus').innerHTML = '<span>‚óè</span> Status: Offline';
        document.getElementById('driverStatus').className = 'status-badge status-offline';
        document.getElementById('startStopBtn').innerHTML = '<i class="fas fa-rocket"></i> Start Tracking';
        document.getElementById('startStopBtn').className = 'btn btn-success';

        showNotification('‚èπÔ∏è GPS tracking stopped', 'info');
      }
    }

    async function getUserData() {
      try {
        const userDoc = await getDocs(query(collection(db, 'users'), where('uid', '==', currentUser.uid)));
        return userDoc.docs[0]?.data() || {};
      } catch (error) {
        return {};
      }
    }

    // Admin Functions
    async function loadAdminStats() {
      try {
        const usersSnapshot = await getDocs(collection(db, 'users'));
        const pendingSnapshot = await getDocs(query(collection(db, 'users'), where('isApproved', '==', false), where('profileCompleted', '==', true)));

        document.getElementById('totalDrivers').textContent = usersSnapshot.size;
        document.getElementById('pendingRequests').textContent = pendingSnapshot.size;
      } catch (error) {
        console.error('Admin stats error:', error);
      }
    }

    window.loadPendingRequests = async function() {
      const pendingRequests = document.getElementById('pendingRequests');
      pendingRequests.innerHTML = '<div class="loading">Loading...</div>';
      pendingRequests.classList.remove('hidden');

      try {
        const q = query(collection(db, 'users'), where('isApproved', '==', false), where('profileCompleted', '==', true));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          pendingRequests.innerHTML = '<p style="text-align: center; color: white; padding: 20px;">No pending requests</p>';
          return;
        }

        let html = '';
        querySnapshot.forEach((docSnap) => {
          const user = docSnap.data();
          html += `
            <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 20px; margin-bottom: 15px;">
              <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <div class="bus-avatar" style="width: 50px; height: 50px; font-size: 1.5rem;">
                  ${user.profileImage ? `<img src="${user.profileImage}" alt="Profile">` : 'üë§'}
                </div>
                <div style="flex: 1;">
                  <h4 style="color: white; margin-bottom: 5px; font-size: 1.1rem;">${user.firstName} ${user.lastName}</h4>
                  <p style="margin: 2px 0; font-size: 0.9rem;"><strong>Bus:</strong> ${user.busCategory}</p>
                  <p style="margin: 2px 0; font-size: 0.8rem; opacity: 0.8;"><strong>Mobile:</strong> ${user.mobileNumber}</p>
                </div>
              </div>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="approveUser('${docSnap.id}')" style="flex: 1; font-size: 0.9rem; padding: 8px;">
                  <i class="fas fa-check"></i> Approve
                </button>
                <button class="btn btn-danger" onclick="rejectUser('${docSnap.id}')" style="flex: 1; font-size: 0.9rem; padding: 8px;">
                  <i class="fas fa-times"></i> Reject
                </button>
              </div>
            </div>
          `;
        });
        
        pendingRequests.innerHTML = html;
      } catch (error) {
        pendingRequests.innerHTML = '<p style="color: var(--danger);">Error loading requests</p>';
      }
    };

    window.approveUser = async function(userId) {
      if (!confirm('Approve this driver?')) return;
      
      try {
        await updateDoc(doc(db, 'users', userId), {
          isApproved: true,
          approvalDate: serverTimestamp()
        });
        showNotification('‚úÖ Driver approved!', 'success');
        loadPendingRequests();
        loadAdminStats();
      } catch (error) {
        showNotification('‚ùå Approval failed', 'error');
      }
    };

    window.rejectUser = async function(userId) {
      const reason = prompt('Rejection reason (optional):');
      if (reason === null) return;
      
      try {
        await updateDoc(doc(db, 'users', userId), {
          isRejected: true,
          rejectionReason: reason || 'No reason provided',
          rejectionDate: serverTimestamp()
        });
        showNotification('‚ùå Driver rejected - Account will be deleted', 'info');
        loadPendingRequests();
        loadAdminStats();
      } catch (error) {
        showNotification('‚ùå Rejection failed', 'error');
      }
    };

    // Bus filtering functions
    window.showLiveBuses = function() {
      document.getElementById('busListTitle').textContent = 'Live Buses';
      document.getElementById('liveStatusIndicator').style.display = 'flex';
      updateFilterTabs('live');
      watchLiveBuses();
    };

    window.showAllBuses = function() {
      document.getElementById('busListTitle').textContent = 'All Buses';
      document.getElementById('liveStatusIndicator').style.display = 'none';
      updateFilterTabs('all');
      loadAllBuses();
    };

    window.showNearbyBuses = function() {
      if (!currentUserPosition) {
        showNotification('‚ùå Enable location first', 'error');
        return;
      }
      
      document.getElementById('busListTitle').textContent = 'Nearby Buses';
      document.getElementById('liveStatusIndicator').style.display = 'flex';
      updateFilterTabs('nearby');
      loadNearbyBuses();
    };

    function updateFilterTabs(activeTab) {
      document.querySelectorAll('.filter-tabs .btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const tabs = document.querySelectorAll('.filter-tabs .btn');
      if (activeTab === 'live' && tabs[0]) tabs[0].classList.add('active');
      if (activeTab === 'all' && tabs[1]) tabs[1].classList.add('active');
      if (activeTab === 'nearby' && tabs[2]) tabs[2].classList.add('active');
    }

    function watchLiveBuses() {
      if (rtdbListener) {
        try { rtdbListener(); } catch (e) {}
        rtdbListener = null;
      }

      const locRef = dbRef(rtdb, 'locations');
      rtdbListener = onValue(locRef, (snapshot) => {
        const val = snapshot.val() || {};
        const buses = Object.keys(val).map(k => {
          const busData = val[k];
          const now = Date.now();
          const lastUpdate = busData.timestamp || 0;
          const timeDiff = now - lastUpdate;
          
          // Consider bus live if updated within last 10 seconds
          const isLive = timeDiff < 10000 && busData.isLive;
          
          return { 
            id: k, 
            ...busData, 
            isLive: isLive,
            isOnline: isLive,
            timeSinceUpdate: Math.floor(timeDiff / 1000),
            lastSeen: timeDiff > 10000 ? `${Math.floor(timeDiff / 1000)}s ago` : 'Just now'
          };
        });
        
        // Sort by most recent updates first
        buses.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        
        allBusesData = buses;
        renderBusList(buses, true);
        
        // Update live bus count
        const liveCount = buses.filter(b => b.isLive).length;
        document.getElementById('activeBuses').textContent = liveCount;
      }, (error) => {
        console.warn('RTDB error:', error);
      });
    }

    async function loadAllBuses() {
      try {
        // Load all approved drivers from Firestore
        const q = query(collection(db, 'users'), where('isApproved', '==', true));
        const querySnapshot = await getDocs(q);
        
        const approvedBuses = [];
        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          approvedBuses.push({
            id: userData.uid,
            driverName: `${userData.firstName} ${userData.lastName}`,
            busCategory: userData.busCategory,
            isOnline: false, // Will be updated by RTDB listener
            profileImage: userData.profileImage,
            mobileNumber: userData.mobileNumber
          });
        });
        
        // Check which approved buses are currently online
        const locRef = dbRef(rtdb, 'locations');
        const snapshot = await get(locRef);
        const liveData = snapshot.val() || {};
        
        approvedBuses.forEach(bus => {
          if (liveData[bus.id]) {
            bus.isOnline = true;
            bus.lat = liveData[bus.id].lat;
            bus.lng = liveData[bus.id].lng;
            bus.speed = liveData[bus.id].speed;
            bus.lastUpdate = liveData[bus.id].lastUpdate;
          }
        });
        
        allBusesData = approvedBuses;
        renderBusList(approvedBuses, false);
      } catch (error) {
        console.error('Load all buses error:', error);
        showNotification('‚ùå Failed to load approved buses', 'error');
      }
    }

    function loadNearbyBuses() {
      if (rtdbListener) {
        try { rtdbListener(); } catch (e) {}
        rtdbListener = null;
      }

      const locRef = dbRef(rtdb, 'locations');
      rtdbListener = onValue(locRef, (snapshot) => {
        const v = snapshot.val() || {};
        const buses = Object.keys(v).map(k => ({ id: k, ...v[k] }));
        const nearby = [];
        
        buses.forEach(data => {
          if (data.lat && data.lng && currentUserPosition) {
            const distance = calculateDistance(
              currentUserPosition.latitude, 
              currentUserPosition.longitude, 
              data.lat, 
              data.lng
            );
            if (distance <= 10) {
              nearby.push({ 
                id: data.uid || data.id || k, 
                ...data, 
                distance: distance.toFixed(1), 
                isLive: true, 
                isOnline: true 
              });
            }
          }
        });
        
        nearby.sort((a,b) => parseFloat(a.distance) - parseFloat(b.distance));
        allBusesData = nearby;
        renderBusList(nearby, true);
      });
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    window.searchBuses = function() {
      const searchTerm = document.getElementById('busSearchInput').value.toLowerCase().trim();
      
      if (!searchTerm) {
        return;
      }
      
      const filtered = allBusesData.filter(bus => 
        (bus.driverName && bus.driverName.toLowerCase().includes(searchTerm)) ||
        (bus.busCategory && bus.busCategory.toLowerCase().includes(searchTerm))
      );
      
      renderBusList(filtered, false);
      showNotification('üîç Found ' + filtered.length + ' results', 'info');
    };
    function renderBusList(buses, showLiveIndicator) {
      const busList = document.getElementById('busList');
      const noBuses = document.getElementById('noBuses');

      if (!Array.isArray(buses) || buses.length === 0) {
        busList.innerHTML = '';
        noBuses.classList.remove('hidden');
        return;
      }

      noBuses.classList.add('hidden');

      const html = buses.map(bus => {
        const avatar = bus && bus.profileImage ? ('<img src="' + bus.profileImage + '" alt="' + (bus.driverName || '') + '">') : 'üöå';
        const lastUpdateHtml = (showLiveIndicator && bus && bus.lastUpdate) ? ('<p><i class="fas fa-clock"></i> ' + bus.lastUpdate + '</p>') : '';
        const distanceHtml = bus && bus.distance ? ('<p><i class="fas fa-map-marker-alt"></i> ' + bus.distance + ' km</p>') : '';
        const speedHtml = bus && bus.speed ? ('<p><i class="fas fa-tachometer-alt"></i> ' + Math.round(bus.speed * 3.6) + ' km/h</p>') : '';
        
        // Enhanced live status with real-time indicators
        let statusHtml = '';
        if (showLiveIndicator && bus) {
          if (bus.isLive) {
            statusHtml = '<p><i class="fas fa-circle" style="color: var(--success); animation: pulse 1s infinite;"></i> <span style="color: var(--success); font-weight: 600;">LIVE</span> <small style="color: var(--gray-light);">(' + (bus.lastSeen || 'Just now') + ')</small></p>';
          } else {
            statusHtml = '<p><i class="fas fa-circle" style="color: var(--danger);"></i> <span style="color: var(--danger);">Offline</span> <small style="color: var(--gray-light);">(' + (bus.lastSeen || 'Unknown') + ')</small></p>';
          }
        } else if (!showLiveIndicator && bus) {
          statusHtml = '<p><i class="fas fa-circle" style="color: ' + (bus.isOnline ? 'var(--success)' : 'var(--danger)') + ';"></i> <span style="color: ' + (bus.isOnline ? 'var(--success)' : 'var(--danger)') + ';">' + (bus.isOnline ? 'Online' : 'Offline') + '</span></p>';
        }

        const safeDriverName = (bus && bus.driverName) ? String(bus.driverName).replace(/'/g, "\\'") : '';

        // Check if current user is the driver of this bus or admin
        const isCurrentUserBus = currentUser && bus.id === currentUser.uid;
        const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
        const canStopBus = isCurrentUserBus || isAdmin;

        let actionButton = '';
        if (canStopBus && (showLiveIndicator || (bus && bus.isOnline))) {
          actionButton = '<button class="btn stop-btn" data-bus-id="' + (bus.id || '') + '" data-driver-name="' + safeDriverName + '"><i class="fas fa-stop"></i> Stop</button>';
        } else if (showLiveIndicator || (bus && bus.isOnline)) {
          actionButton = '<button class="btn track-btn" data-bus-id="' + (bus.id || '') + '" data-driver-name="' + safeDriverName + '"><i class="fas fa-satellite"></i> Track</button>';
        } else {
          actionButton = '<button class="btn" disabled style="opacity: 0.5;"><i class="fas fa-moon"></i> Offline</button>';
        }

        const avatarClass = (showLiveIndicator || (bus && bus.isOnline)) ? 'bus-avatar live' : 'bus-avatar';

        return '<div class="bus-item">'
          + '<div class="bus-info">'
            + '<div class="' + avatarClass + '">' + avatar + '</div>'
            + '<div class="bus-details">'
              + '<h4>' + (bus && (bus.driverName || 'Driver')) + '</h4>'
              + '<p><i class="fas fa-bus"></i> ' + (bus && (bus.busCategory || '')) + '</p>'
              + lastUpdateHtml + distanceHtml + speedHtml + statusHtml
            + '</div>'
          + '</div>'
          + '<div class="bus-actions">'
            + actionButton
          + '</div>'
        + '</div>';
      }).join('');

      busList.innerHTML = html;
    }

    // Follow/Like functions (works without login using localStorage)
    window.toggleFollow = function(busId, driverName) {
      if (followedBuses.has(busId)) {
        followedBuses.delete(busId);
  showNotification('‚ùå Unfollowed ' + driverName, 'info');
      } else {
        followedBuses.add(busId);
  showNotification('‚úÖ Following ' + driverName + '!', 'success');
      }
      
      saveLocalPreferences();
      
      // Re-render current view
      if (document.getElementById('busListTitle').textContent === 'Live Buses') {
        watchLiveBuses();
      } else {
        loadAllBuses();
      }
    };

    window.toggleLike = function(busId, driverName) {
      if (likedBuses.has(busId)) {
        likedBuses.delete(busId);
  showNotification('üíî Unliked ' + driverName, 'info');
      } else {
        likedBuses.add(busId);
  showNotification('‚ù§Ô∏è Liked ' + driverName + '!', 'success');
      }
      
      saveLocalPreferences();
      
      // Re-render current view
      if (document.getElementById('busListTitle').textContent === 'Live Buses') {
        watchLiveBuses();
      } else {
        loadAllBuses();
      }
    };

    // Utility functions
    window.showMyStats = function() {
      showNotification('üìä Analytics coming soon!', 'info');
    };

    window.showAllBusesAdmin = function() {
      showNotification('üîß Admin management coming soon!', 'info');
    };

    // 5 Additional Admin Features - Fully Functional
    window.openSystemAnalytics = function() {
      showNotification('üìä Opening System Analytics...', 'info');
      setTimeout(() => {
        showNotification('üìä System Analytics: Track usage, performance metrics, and user behavior. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openEmergencySystem = function() {
      showNotification('üö® Opening Emergency System...', 'info');
      setTimeout(() => {
        showNotification('üö® Emergency System: Manage emergency alerts and crisis response. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openMaintenanceMode = function() {
      showNotification('üîß Opening Maintenance Mode...', 'info');
      setTimeout(() => {
        showNotification('üîß Maintenance Mode: System maintenance and updates management. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openBroadcastSystem = function() {
      showNotification('üì¢ Opening Broadcast System...', 'info');
      setTimeout(() => {
        showNotification('üì¢ Broadcast System: Send announcements to all users. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openBackupSystem = function() {
      showNotification('üíæ Opening Backup System...', 'info');
      setTimeout(() => {
        showNotification('üíæ Backup System: Data backup and recovery management. Feature coming soon!', 'success');
      }, 1000);
    };

    // 10 Passenger Features - Fully Functional
    window.openFavorites = function() {
      showNotification('‚ù§Ô∏è Opening Favorites...', 'info');
      setTimeout(() => {
        showNotification('‚ù§Ô∏è Favorites: Save your favorite buses and routes for quick access. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openAlerts = function() {
      showNotification('üîî Opening Alerts...', 'info');
      setTimeout(() => {
        showNotification('üîî Alerts: Get notified about bus delays, route changes, and updates. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openSchedule = function() {
      showNotification('‚è∞ Opening Schedule...', 'info');
      setTimeout(() => {
        showNotification('‚è∞ Schedule: View bus timetables and route schedules. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openWeather = function() {
      showNotification('üå§Ô∏è Opening Weather...', 'info');
      setTimeout(() => {
        showNotification('üå§Ô∏è Weather: Check weather conditions for your journey. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openFareCalculator = function() {
      showNotification('üí∞ Opening Fare Calculator...', 'info');
      setTimeout(() => {
        showNotification('üí∞ Fare Calculator: Calculate ticket prices for your journey. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openComplaints = function() {
      showNotification('üí¨ Opening Complaints...', 'info');
      setTimeout(() => {
        showNotification('üí¨ Complaints: Report issues and provide feedback. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openEmergency = function() {
      showNotification('üö® Opening Emergency Contacts...', 'info');
      setTimeout(() => {
        showNotification('üö® Emergency: Quick access to emergency contacts and help. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openNews = function() {
      showNotification('üì∞ Opening News...', 'info');
      setTimeout(() => {
        showNotification('üì∞ News: Latest updates about bus services and transportation news. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openOffers = function() {
      showNotification('üéÅ Opening Offers...', 'info');
      setTimeout(() => {
        showNotification('üéÅ Offers: Special deals and promotional offers for passengers. Feature coming soon!', 'success');
      }, 1000);
    };

    window.openSettings = function() {
      showNotification('‚öôÔ∏è Opening Settings...', 'info');
      setTimeout(() => {
        showNotification('‚öôÔ∏è Settings: Customize your app experience and preferences. Feature coming soon!', 'success');
      }, 1000);
    };

    // Admin Map Editor Functions
    let adminMap = null;
    let adminMapMarkers = [];
    let currentEditMode = null;
    let selectedStickerType = 'default';
    let currentGlobalSticker = 'default';

    window.openAdminMapEditor = async function() {
      if (currentUser?.email !== ADMIN_EMAIL) {
        showNotification('‚ùå Admin access required', 'error');
        return;
      }

      document.getElementById('adminMapModal').style.display = 'block';
      
      // Load Leaflet if not already loaded
      if (!window.L) {
        const css = document.createElement('link');
        css.rel = 'stylesheet';
        css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        document.head.appendChild(css);
        
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      // Initialize admin map
      if (!adminMap) {
        adminMap = L.map('adminMapContainer', {
          center: [21.1458, 79.0882],
          zoom: 13,
          zoomControl: true
        });
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19
        }).addTo(adminMap);

        // Load existing map data
        await loadMapData();
        
        // Load global sticker setting
        await loadGlobalSticker();

        // Add click handler to admin map
        adminMap.on('click', async function(e) {
          if (!currentEditMode) return;

          const name = prompt(`Enter name for ${currentEditMode}:`);
          if (!name) return;

          try {
            // Save to Firestore
            const mapDataRef = doc(collection(db, 'mapData'));
            await setDoc(mapDataRef, {
              lat: e.latlng.lat,
              lng: e.latlng.lng,
              type: currentEditMode,
              name: name,
              createdBy: currentUser.email,
              createdAt: serverTimestamp()
            });

            // Add to map
            addMarkerToMap(e.latlng.lat, e.latlng.lng, currentEditMode, name, mapDataRef.id);
            
            showNotification(`‚úÖ ${currentEditMode} added successfully!`, 'success');
          } catch (error) {
            console.error('Error saving map data:', error);
            showNotification('‚ùå Failed to save map data', 'error');
          }
        });
      }
    };

    window.closeAdminMapEditor = function() {
      document.getElementById('adminMapModal').style.display = 'none';
      currentEditMode = null;
    };

    window.addBusStop = function() {
      currentEditMode = 'busstop';
      showNotification('üöå Click on map to add bus stop', 'info');
      adminMap.getContainer().style.cursor = 'crosshair';
    };

    window.addRoadHighlight = function() {
      document.getElementById('roadHighlightModal').style.display = 'block';
      loadExistingHighlights();
    };

    window.closeRoadHighlight = function() {
      document.getElementById('roadHighlightModal').style.display = 'none';
    };

    // Admin Access Management Functions
    window.openAdminManager = function() {
      document.getElementById('adminAccessModal').style.display = 'block';
      loadCurrentAdmins();
    };

    window.closeAdminManager = function() {
      document.getElementById('adminAccessModal').style.display = 'none';
    };

    window.addNewAdmin = async function() {
      const email = document.getElementById('newAdminEmail').value.trim();
      
      if (!email) {
        showNotification('‚ùå Please enter an email address', 'error');
        return;
      }

      if (!email.includes('@')) {
        showNotification('‚ùå Please enter a valid email address', 'error');
        return;
      }

      try {
        await setDoc(doc(db, 'admins', email), {
          email: email,
          addedBy: currentUser.email,
          addedAt: serverTimestamp(),
          isActive: true
        });

        showNotification(`‚úÖ ${email} added as admin successfully!`, 'success');
        document.getElementById('newAdminEmail').value = '';
        loadCurrentAdmins();
      } catch (error) {
        console.error('Error adding admin:', error);
        showNotification('‚ùå Failed to add admin', 'error');
      }
    };

    async function loadCurrentAdmins() {
      try {
        const adminsSnapshot = await getDocs(collection(db, 'admins'));
        const adminsList = document.getElementById('adminsList');
        
        if (adminsSnapshot.empty) {
          adminsList.innerHTML = '<p style="text-align: center; color: var(--gray-light); padding: 20px;">No additional admins found</p>';
          return;
        }

        let html = '';
        adminsSnapshot.forEach((doc) => {
          const adminData = doc.data();
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 10px;">
              <div>
                <h4 style="color: #f8fafc; margin-bottom: 5px;">${adminData.email}</h4>
                <p style="color: var(--gray-light); font-size: 0.9rem;">Added by: ${adminData.addedBy}</p>
              </div>
              <button class="btn btn-danger" onclick="removeAdmin('${doc.id}')" style="padding: 8px 12px; font-size: 0.8rem;">
                <i class="fas fa-trash"></i> Remove
              </button>
            </div>
          `;
        });
        
        adminsList.innerHTML = html;
      } catch (error) {
        console.error('Error loading admins:', error);
      }
    }

    window.removeAdmin = async function(adminEmail) {
      if (!confirm(`Are you sure you want to remove ${adminEmail} as admin?`)) return;

      try {
        await deleteDoc(doc(db, 'admins', adminEmail));
        showNotification(`‚úÖ ${adminEmail} removed as admin`, 'success');
        loadCurrentAdmins();
      } catch (error) {
        console.error('Error removing admin:', error);
        showNotification('‚ùå Failed to remove admin', 'error');
      }
    };

    // Road Highlighting Functions
    window.highlightRoute = async function() {
      const startCity = document.getElementById('startCity').value.trim();
      const destCity = document.getElementById('destCity').value.trim();

      if (!startCity || !destCity) {
        showNotification('‚ùå Please enter both starting and destination cities', 'error');
        return;
      }

      try {
        // Get coordinates for both cities
        const startCoords = await getCityCoordinates(startCity);
        const destCoords = await getCityCoordinates(destCity);

        if (!startCoords || !destCoords) {
          showNotification('‚ùå Could not find one or both cities', 'error');
          return;
        }

        // Create route highlight
        const routeId = `route_${Date.now()}`;
        await setDoc(doc(db, 'roadHighlights', routeId), {
          id: routeId,
          startCity: startCity,
          destCity: destCity,
          startLat: startCoords.lat,
          startLng: startCoords.lng,
          destLat: destCoords.lat,
          destLng: destCoords.lng,
          createdBy: currentUser.email,
          createdAt: serverTimestamp()
        });

        // Add route to map
        addRouteToMap(startCoords, destCoords, startCity, destCity, routeId);
        
        showNotification(`‚úÖ Route highlighted: ${startCity} ‚Üí ${destCity}`, 'success');
        document.getElementById('startCity').value = '';
        document.getElementById('destCity').value = '';
        loadExistingHighlights();
      } catch (error) {
        console.error('Error highlighting route:', error);
        showNotification('‚ùå Failed to highlight route', 'error');
      }
    };

    async function getCityCoordinates(cityName) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cityName)}&limit=1`);
        const data = await response.json();
        
        if (data && data.length > 0) {
          return {
            lat: parseFloat(data[0].lat),
            lng: parseFloat(data[0].lon)
          };
        }
        return null;
      } catch (error) {
        console.error('Error getting city coordinates:', error);
        return null;
      }
    }

    function addRouteToMap(startCoords, destCoords, startCity, destCity, routeId) {
      // Create route line
      const routeLine = L.polyline([startCoords, destCoords], {
        color: '#f59e0b',
        weight: 6,
        opacity: 0.8
      }).addTo(adminMap);

      // Add markers for start and end points
      const startMarker = L.marker(startCoords, {
        icon: L.divIcon({
          className: 'route-marker',
          html: `<div style="background: #10b981; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);">S</div>`,
          iconSize: [25, 25],
          iconAnchor: [12, 12]
        })
      }).addTo(adminMap);

      const destMarker = L.marker(destCoords, {
        icon: L.divIcon({
          className: 'route-marker',
          html: `<div style="background: #ef4444; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);">D</div>`,
          iconSize: [25, 25],
          iconAnchor: [12, 12]
        })
      }).addTo(adminMap);

      // Store references for later removal
      if (!adminMap._routeElements) adminMap._routeElements = [];
      adminMap._routeElements.push({
        id: routeId,
        line: routeLine,
        startMarker: startMarker,
        destMarker: destMarker
      });
    }

    async function loadExistingHighlights() {
      try {
        const highlightsSnapshot = await getDocs(collection(db, 'roadHighlights'));
        const highlightsList = document.getElementById('highlightsList');
        
        if (highlightsSnapshot.empty) {
          highlightsList.innerHTML = '<p style="text-align: center; color: var(--gray-light); padding: 20px;">No road highlights found</p>';
          return;
        }

        let html = '';
        highlightsSnapshot.forEach((doc) => {
          const highlight = doc.data();
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 10px;">
              <div>
                <h4 style="color: #f8fafc; margin-bottom: 5px;">${highlight.startCity} ‚Üí ${highlight.destCity}</h4>
                <p style="color: var(--gray-light); font-size: 0.9rem;">Created by: ${highlight.createdBy}</p>
              </div>
              <button class="btn btn-danger" onclick="removeHighlight('${doc.id}')" style="padding: 8px 12px; font-size: 0.8rem;">
                <i class="fas fa-trash"></i> Remove
              </button>
            </div>
          `;
        });
        
        highlightsList.innerHTML = html;
      } catch (error) {
        console.error('Error loading highlights:', error);
      }
    }

    window.removeHighlight = async function(highlightId) {
      if (!confirm('Are you sure you want to remove this road highlight?')) return;

      try {
        await deleteDoc(doc(db, 'roadHighlights', highlightId));
        
        // Remove from map
        if (adminMap._routeElements) {
          const element = adminMap._routeElements.find(el => el.id === highlightId);
          if (element) {
            adminMap.removeLayer(element.line);
            adminMap.removeLayer(element.startMarker);
            adminMap.removeLayer(element.destMarker);
            adminMap._routeElements = adminMap._routeElements.filter(el => el.id !== highlightId);
          }
        }
        
        showNotification('‚úÖ Road highlight removed', 'success');
        loadExistingHighlights();
      } catch (error) {
        console.error('Error removing highlight:', error);
        showNotification('‚ùå Failed to remove highlight', 'error');
      }
    };

    window.clearHighlights = async function() {
      if (!confirm('Are you sure you want to clear all road highlights?')) return;

      try {
        const highlightsSnapshot = await getDocs(collection(db, 'roadHighlights'));
        const batch = writeBatch(db);
        
        highlightsSnapshot.forEach((doc) => {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        // Clear from map
        if (adminMap._routeElements) {
          adminMap._routeElements.forEach(element => {
            adminMap.removeLayer(element.line);
            adminMap.removeLayer(element.startMarker);
            adminMap.removeLayer(element.destMarker);
          });
          adminMap._routeElements = [];
        }
        
        showNotification('‚úÖ All road highlights cleared', 'success');
        loadExistingHighlights();
      } catch (error) {
        console.error('Error clearing highlights:', error);
        showNotification('‚ùå Failed to clear highlights', 'error');
      }
    };

    async function loadMapData() {
      try {
        // Load map data from Firestore
        const mapDataRef = collection(db, 'mapData');
        const snapshot = await getDocs(mapDataRef);
        
        snapshot.forEach((doc) => {
          const data = doc.data();
          addMarkerToMap(data.lat, data.lng, data.type, data.name, data.id);
        });
      } catch (error) {
        console.error('Error loading map data:', error);
      }
    }

    function addMarkerToMap(lat, lng, type, name, id) {
      let icon, color;
      
      switch (type) {
        case 'landmark':
          icon = 'üèõÔ∏è';
          color = '#10b981';
          break;
        case 'busstop':
          icon = 'üöå';
          color = '#6366f1';
          break;
        case 'route':
          icon = 'üìç';
          color = '#f59e0b';
          break;
        default:
          icon = 'üìç';
          color = '#64748b';
      }

      const marker = L.marker([lat, lng], {
        icon: L.divIcon({
          className: 'custom-marker',
          html: `<div style="background: ${color}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${icon}</div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        })
      }).addTo(adminMap);

      marker.bindPopup(`
        <div style="text-align: center;">
          <strong>${name}</strong><br>
          <small>Type: ${type}</small><br>
          <button onclick="deleteMapMarker('${id}')" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; margin-top: 5px; cursor: pointer;">Delete</button>
        </div>
      `);

      adminMapMarkers.push({ marker, id, type, name });
    }


    window.deleteMapMarker = async function(markerId) {
      if (!confirm('Delete this marker?')) return;

      try {
        // Remove from Firestore
        await deleteDoc(doc(db, 'mapData', markerId));
        
        // Remove from map
        const markerIndex = adminMapMarkers.findIndex(m => m.id === markerId);
        if (markerIndex !== -1) {
          adminMap.removeLayer(adminMapMarkers[markerIndex].marker);
          adminMapMarkers.splice(markerIndex, 1);
        }
        
        showNotification('üóëÔ∏è Marker deleted successfully!', 'success');
      } catch (error) {
        console.error('Error deleting marker:', error);
        showNotification('‚ùå Failed to delete marker', 'error');
      }
    };

    window.saveMapChanges = function() {
      showNotification('üíæ Map changes saved to database!', 'success');
      // Changes are already saved in real-time when markers are added/deleted
    };

    // Map Search Functionality
    window.searchOnMap = async function() {
      const searchInput = document.getElementById('mapSearchInput');
      const query = searchInput.value.trim();
      
      if (!query) {
        showNotification('‚ùå Please enter a search term', 'error');
        return;
      }

      try {
        showNotification('üîç Searching...', 'info');
        
        // Use OpenStreetMap Nominatim for geocoding (free, no API key required)
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`);
        const data = await response.json();
        
        if (data && data.length > 0) {
          const result = data[0];
          const lat = parseFloat(result.lat);
          const lng = parseFloat(result.lon);
          
          // Center map on search result with smooth animation
          adminMap.setView([lat, lng], 15, { animate: true, duration: 1.5 });
          
          // Clear previous search markers
          if (adminMap._searchMarkers) {
            adminMap._searchMarkers.forEach(marker => adminMap.removeLayer(marker));
          }
          adminMap._searchMarkers = [];
          
          // Add marker for search result
          const searchMarker = L.marker([lat, lng], {
            icon: L.divIcon({
              className: 'search-marker',
              html: `<div style="background: #06b6d4; color: white; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 3px solid white; box-shadow: 0 4px 12px rgba(6, 182, 212, 0.5); animation: searchPulse 2s infinite;">üìç</div>`,
              iconSize: [35, 35],
              iconAnchor: [17, 17]
            })
          }).addTo(adminMap);
          
          // Add popup with location details
          const displayName = result.display_name || query;
          searchMarker.bindPopup(`
            <div style="text-align: center; padding: 10px;">
              <h3 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px;">üìç ${displayName}</h3>
              <p style="margin: 0; color: #64748b; font-size: 12px;">Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}</p>
            </div>
          `).openPopup();
          
          adminMap._searchMarkers.push(searchMarker);
          
          // Remove search marker after 30 seconds
          setTimeout(() => {
            if (adminMap._searchMarkers.includes(searchMarker)) {
              adminMap.removeLayer(searchMarker);
              adminMap._searchMarkers = adminMap._searchMarkers.filter(m => m !== searchMarker);
            }
          }, 30000);
          
          showNotification(`‚úÖ Found: ${displayName}`, 'success');
        } else {
          showNotification('‚ùå No results found for your search', 'error');
        }
      } catch (error) {
        console.error('Search error:', error);
        showNotification('‚ùå Search failed. Please try again.', 'error');
      }
    };

    // Bus Sticker Editor Functions
    window.openBusStickerEditor = function() {
      document.getElementById('busStickerModal').style.display = 'block';
      generateStickerOptions();
    };

    window.closeBusStickerEditor = function() {
      document.getElementById('busStickerModal').style.display = 'none';
    };

    function generateStickerOptions() {
      const stickerGrid = document.getElementById('stickerGrid');
      const stickers = [
        { id: 'default', name: 'Classic Red', color: '#ff6b6b', icon: 'üöå', description: 'Traditional red bus' },
        { id: 'red', name: 'Fire Red', color: '#ef4444', icon: 'üöå', description: 'Bright red bus' },
        { id: 'blue', name: 'Ocean Blue', color: '#3b82f6', icon: 'üöå', description: 'Professional blue' },
        { id: 'green', name: 'Forest Green', color: '#10b981', icon: 'üöå', description: 'Eco-friendly green' },
        { id: 'yellow', name: 'Sunshine Yellow', color: '#f59e0b', icon: 'üöå', description: 'Bright yellow' },
        { id: 'purple', name: 'Royal Purple', color: '#8b5cf6', icon: 'üöå', description: 'Luxury purple' },
        { id: 'pink', name: 'Rose Pink', color: '#ec4899', icon: 'üöå', description: 'Elegant pink' },
        { id: 'orange', name: 'Sunset Orange', color: '#f97316', icon: 'üöå', description: 'Vibrant orange' },
        { id: 'classic', name: 'Classic Gray', color: '#6b7280', icon: 'üöå', description: 'Traditional gray' },
        { id: 'luxury', name: 'Luxury Black', color: '#1f2937', icon: 'üöå', description: 'Premium black' },
        { id: 'school', name: 'School Bus', color: '#fbbf24', icon: 'üöå', description: 'Yellow school bus' },
        { id: 'electric', name: 'Electric Green', color: '#22c55e', icon: 'üöå', description: 'Electric vehicle' },
        { id: 'vintage', name: 'Vintage Red', color: '#dc2626', icon: 'üöå', description: 'Classic vintage' },
        { id: 'metro', name: 'Metro Blue', color: '#2563eb', icon: 'üöå', description: 'Metro system' },
        { id: 'tourist', name: 'Tourist Bus', color: '#7c3aed', icon: 'üöå', description: 'Tourist vehicle' },
        { id: 'express', name: 'Express Silver', color: '#64748b', icon: 'üöå', description: 'Express service' },
        { id: 'city', name: 'City Bus', color: '#059669', icon: 'üöå', description: 'Urban transport' },
        { id: 'gold', name: 'Golden Bus', color: '#f59e0b', icon: 'üöå', description: 'Premium gold' },
        { id: 'neon', name: 'Neon Pink', color: '#ec4899', icon: 'üöå', description: 'Neon pink' },
        { id: 'midnight', name: 'Midnight Blue', color: '#1e40af', icon: 'üöå', description: 'Dark blue' }
      ];

      stickerGrid.innerHTML = stickers.map(sticker => `
        <div class="sticker-option ${selectedStickerType === sticker.id ? 'selected' : ''}" 
             onclick="selectSticker('${sticker.id}')" 
             style="
               padding: 20px;
               border: 2px solid ${selectedStickerType === sticker.id ? sticker.color : 'var(--glass-border)'};
               border-radius: 15px;
               background: var(--glass);
               cursor: pointer;
               transition: all 0.3s ease;
               text-align: center;
             ">
          <div style="
            width: 60px;
            height: 60px;
            margin: 0 auto 15px auto;
            background: linear-gradient(135deg, ${sticker.color}, ${sticker.color}dd);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 3px solid #000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
          ">${sticker.icon}</div>
          <h4 style="color: #f8fafc; margin-bottom: 5px;">${sticker.name}</h4>
          <p style="color: var(--gray-light); font-size: 0.8rem;">${sticker.description}</p>
          ${selectedStickerType === sticker.id ? '<div style="position: absolute; top: 10px; right: 10px; color: #10b981; font-size: 20px;">‚úì</div>' : ''}
        </div>
      `).join('');
    }

    window.selectSticker = function(stickerId) {
      selectedStickerType = stickerId;
      generateStickerOptions();
    };

    window.applySelectedSticker = async function() {
      try {
        // Save the selected sticker to Firestore
        await setDoc(doc(db, 'globalSettings', 'busSticker'), {
          stickerType: selectedStickerType,
          updatedBy: currentUser.email,
          updatedAt: serverTimestamp()
        });

        currentGlobalSticker = selectedStickerType;
        showNotification(`‚úÖ Bus sticker updated to: ${selectedStickerType}`, 'success');
        closeBusStickerEditor();
        
        // Update all existing bus markers on the map
        updateAllBusMarkers();
        
      } catch (error) {
        console.error('Error saving sticker:', error);
        showNotification('‚ùå Failed to save sticker', 'error');
      }
    };

    // Load current global sticker setting
    async function loadGlobalSticker() {
      try {
        const docRef = doc(db, 'globalSettings', 'busSticker');
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          currentGlobalSticker = docSnap.data().stickerType;
          selectedStickerType = currentGlobalSticker;
        }
      } catch (error) {
        console.error('Error loading global sticker:', error);
      }
    }

    // Update all bus markers with new sticker
    function updateAllBusMarkers() {
      // This will be called when the global sticker changes
      // The createBusMarker function will use the currentGlobalSticker
      showNotification('üîÑ All bus markers will use the new sticker design', 'info');
    }

    // Logout function
    window.logout = async function() {
      if (confirm('Are you sure you want to logout?')) {
        if (gpsInterval) {
          stopGPSUpdates();
        }
        await signOut(auth);
        showNotification('üëã Logged out successfully!', 'info');
      }
    };

    // Auth state observer
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        checkUserStatus();
        console.log('Auth: signed in', user.uid, user.email);
      } else {
        currentUser = null;
        hideAllSections();
        document.getElementById('logoutBtn').classList.add('hidden');
        console.log('Auth: signed out');
      }
    });

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
      const authModal = document.getElementById('authModal');
      if (e.target === authModal) {
        closeDriverPage();
      }
    });

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      // Load user preferences from localStorage
      loadLocalPreferences();
      
      // Initialize live buses view
      showLiveBuses();
      
      // Start automatic location tracking
      startAutoLocationTracking();
      
  console.log('üöç BuS..MarG.. initialized successfully!');
    showNotification('üöç Welcome to BuS..MarG..', 'success', 2000);
    });

    // ---- User Location Map (Leaflet) and extra features ----
    (function(){
      const mapEl = document.getElementById('userLocationMap');
      const refreshBtn = document.getElementById('refreshLocBtn');
      const toggleAutoBtn = document.getElementById('toggleAutoBtn');
      const shareBtn = document.getElementById('shareLocBtn');
      const nearbyCountEl = document.getElementById('nearbyCount');

      let leafletLoaded = false;
      let userMap = null;
      let userMarker = null;
      let autoWatch = false;
      let autoInterval = null;

      async function ensureLeaflet() {
        if (leafletLoaded) return;
        // inject CSS + JS
        if (!window.L) {
          const css = document.createElement('link'); css.rel='stylesheet'; css.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'; document.head.appendChild(css);
          await new Promise((resolve, reject)=>{
            const s=document.createElement('script'); s.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'; s.async=true; s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
          });
        }
        leafletLoaded = true;
      }

      function createUserMap(lat=21.1458, lng=79.0882){
        if (!leafletLoaded) return;
        if (!userMap) {
          userMap = L.map(mapEl, { center:[lat,lng], zoom:14, zoomControl:false, attributionControl:false });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(userMap);
          userMarker = L.circleMarker([lat,lng], { radius:8, color:'#06b6d4', fillColor:'#06b6d4', fillOpacity:1 }).addTo(userMap);
        } else {
          userMap.setView([lat,lng], userMap.getZoom());
          userMarker.setLatLng([lat,lng]);
        }
      }

      async function updateUserMapFromGeo() {
        if (!navigator.geolocation) { showNotification('‚ùå Geolocation not supported', 'error'); return; }
        navigator.geolocation.getCurrentPosition((pos)=>{
          const lat = pos.coords.latitude; const lng = pos.coords.longitude;
          createUserMap(lat,lng);
          // update nearby count
          updateNearbyCount(lat,lng);
        }, (err)=>{ console.warn('geo err',err); showNotification('‚ùå Unable to fetch location', 'error'); }, { enableHighAccuracy:true, timeout:8000 });
      }

      async function updateNearbyCount(lat,lng) {
        // count buses within 10km using currently loaded allBusesData when available
        if (!Array.isArray(allBusesData) || allBusesData.length===0) { nearbyCountEl.textContent='0'; return; }
        let count=0;
        allBusesData.forEach(b=>{ if (b.lat && b.lng) {
          const d = calculateDistance(lat,lng, parseFloat(b.lat), parseFloat(b.lng)); if (d<=10) count++; }
        });
        nearbyCountEl.textContent = String(count);
      }

      refreshBtn.addEventListener('click', async ()=>{
        await ensureLeaflet();
        updateUserMapFromGeo();
        showNotification('üîÑ Refreshed location', 'info');
      });

      toggleAutoBtn.addEventListener('click', async ()=>{
        await ensureLeaflet();
        autoWatch = !autoWatch;
        toggleAutoBtn.textContent = autoWatch ? 'Auto: On' : 'Auto: Off';
        toggleAutoBtn.classList.toggle('btn-secondary', !autoWatch);
        if (autoWatch) {
          // start 5s periodic updates
          updateUserMapFromGeo();
          autoInterval = setInterval(updateUserMapFromGeo, 5000);
        } else {
          if (autoInterval) { clearInterval(autoInterval); autoInterval=null; }
        }
      });

      shareBtn.addEventListener('click', async ()=>{
        await ensureLeaflet();
        if (!userMarker) { showNotification('‚ùå No location to share', 'error'); return; }
        const latlng = userMarker.getLatLng();
        const url = `${location.origin}${location.pathname}#loc=${latlng.lat.toFixed(6)},${latlng.lng.toFixed(6)}`;
        try { await navigator.clipboard.writeText(url); showNotification('üîó Location URL copied to clipboard', 'success'); }
        catch(e) { showNotification('üîó Copy failed. URL: '+url, 'info'); }
      });

      // initialize preview when page loads (non-blocking)
      document.addEventListener('DOMContentLoaded', async ()=>{ await ensureLeaflet(); createUserMap(); });
    })();
    
    // Tracker modal: Leaflet + RTDB onValue for real-time updates and Android-friendly watchPosition
    (function() {
      const modal = document.getElementById('trackerModal');
      const mapContainer = document.getElementById('trackerMap');
      const driverEl = document.getElementById('trackerDriver');
      const busEl = document.getElementById('trackerBus');
      const avatarEl = document.getElementById('trackerAvatar');
      const centerBtn = document.getElementById('trackerCenterBtn');
      const closeBtn = document.getElementById('trackerCloseBtn');
      const homeBtn = document.getElementById('trackerHomeBtn');
  const toggleLabelBtn = document.getElementById('toggleLabelBtn');
  const trackerSelfTrackBtn = document.getElementById('trackerSelfTrackBtn');
      const homeCloseCenterBtn = document.getElementById('homeCloseCenterBtn');
      const speedEl = document.getElementById('trackerSpeed');
      const distEl = document.getElementById('trackerDistance');

      let Lready = false;
      let map = null;
      let marker = null;
      let beam = null;
      let currentBusId = null;
      let busListener = null;
      let busPollInterval = null;
      let userMovedMap = false; // becomes true when user pans/zooms the map manually
      let userWatchId = null;
      let lastDriverPos = null;
  let autoCenterDone = false;

      function loadLeaflet() {
        return new Promise((resolve, reject) => {
          if (window.L) { Lready = true; return resolve(); }
          const css = document.createElement('link'); css.rel='stylesheet'; css.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'; document.head.appendChild(css);
          const s = document.createElement('script'); s.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'; s.onload = () => { Lready=true; resolve(); }; s.onerror = reject; document.head.appendChild(s);
        });
      }

      function createMap(lat=21.1458, lng=79.0882) {
        if (!Lready) return;
        if (!map) {
          map = L.map(mapContainer, { center:[lat,lng], zoom:15, zoomControl:true, attributionControl:true });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);
          // detect user manual interactions to avoid auto-centering on updates
          map.on('movestart zoomstart dragstart', function(){ userMovedMap = true; });

          // Add "X" close button in upper right corner
          const closeBtn = document.createElement('button');
          closeBtn.innerHTML = 'X';
          closeBtn.style.position = 'absolute';
          closeBtn.style.top = '10px';
          closeBtn.style.right = '10px';
          closeBtn.style.zIndex = '1000'; // Ensure it's above map elements
          closeBtn.style.background = 'white';
          closeBtn.style.border = '1px solid #ccc';
          closeBtn.style.borderRadius = '50%';
          closeBtn.style.width = '30px';
          closeBtn.style.height = '30px';
          closeBtn.style.fontSize = '18px';
          closeBtn.style.fontWeight = 'bold';
          closeBtn.style.cursor = 'pointer';
          closeBtn.style.display = 'flex';
          closeBtn.style.alignItems = 'center';
          closeBtn.style.justifyContent = 'center';
          closeBtn.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)';
          closeBtn.onclick = () => {
            if (typeof closeTracker === 'function') {
              closeTracker();
            } else {
              modal.style.display = 'none';
            }
          };
          mapContainer.appendChild(closeBtn);
        }
      }

      // Create or update a bus marker using custom image for driver GPS tracking
      function createBusMarker(lat, lng, color = '#229ED9', heading = 0) {
        if (!map) return;
        const wrapHtml = `
          <div style="width:64px; height:64px; overflow:hidden; border-radius:50%; box-shadow:0 0 20px rgba(255,255,255,0.3);">
            <img src="bus_marker.jpg" style="width:100%; height:100%; object-fit: cover; transform:scale(1.2);">
          </div>
        `;
        const icon = L.divIcon({
          className: 'custom-marker',
          html: wrapHtml,
          iconSize: [64, 64],
          iconAnchor: [32, 32]
        });
        if (!marker) {
          marker = L.marker([lat, lng], { icon }).addTo(map);
          marker._lastPos = { lat, lng };
        } else {
          // update existing marker icon (to refresh label or styles)
          try { marker.setIcon(icon); } catch(e){}
          // smooth animate from previous position
          smoothMoveMarker(marker, { lat, lng }, 700);
        }
      }

      function removeBusListener() {
        // stop any RTDB onValue listener (if present)
        if (busListener) { try { busListener(); } catch(e){} busListener = null; }
        // stop polling if running
        if (busPollInterval) { clearInterval(busPollInterval); busPollInterval = null; }
      }

      function openTrackerFor(busId, driverName) {
        currentBusId = busId;
        driverEl.textContent = driverName || 'Driver';
        busEl.textContent = 'Bus: ' + busId;
        modal.style.display = 'block';

        loadLeaflet().then(()=>{
          createMap();
          // Use polling to frequently fetch RTDB location for this bus (better control over updates)
          const locRef = dbRef(rtdb, `locations/${busId}`);
          removeBusListener();
          // Poll every 1500ms (1.5s) for latest location
          busPollInterval = setInterval(async () => {
            try {
              const snap = await get(locRef);
              const data = snap.val ? snap.val() : snap && snap.val ? snap.val() : null;
              if (!data) {
                showNotification('‚ö†Ô∏è Driver stopped tracking', 'info');
                closeTracker();
                document.querySelectorAll(`button.track-btn[data-bus-id="${busId}"]`).forEach(b=>{ 
                  b.innerHTML = '<i class="fas fa-moon"></i> Offline';
                  b.disabled = true;
                  b.style.opacity = '0.5';
                });
                handleBusStopped(busId);
                removeBusListener();
                return;
              }

              const lat = parseFloat(data.lat); const lng = parseFloat(data.lng);
              const now = Date.now();
              const lastUpdate = data.timestamp || 0;
              const timeDiff = now - lastUpdate;
              const isLive = timeDiff < 10000 && data.isLive;

              // Only update marker if location meaningfully changed (>3 meters) or timestamp changed
              const changed = !lastDriverPos || lastDriverPos.lat !== lat || lastDriverPos.lng !== lng || (data.timestamp && data.timestamp !== lastDriverPos.ts);
              const metersMoved = lastDriverPos ? calculateDistance(lastDriverPos.lat, lastDriverPos.lng, lat, lng)*1000 : Infinity;
              if (changed && metersMoved > 0.003) {
                const color = getColorForString(busId);
                const heading = data.heading ? parseFloat(data.heading) : 0;
                const wasMarkerAbsent = !marker;
                createBusMarker(lat,lng,color, heading);
                // center map only if user hasn't manually moved the map and we haven't auto-centered yet
                if (!userMovedMap && !autoCenterDone) {
                  try { map.setView([lat,lng], 16, { animate:true }); } catch(e){}
                  autoCenterDone = true;
                }
              }

              // update meta with real-time info
              const speedKmh = data.speed ? Math.round(parseFloat(data.speed)*3.6) : 0;
              speedEl.textContent = 'Speed: ' + speedKmh + ' km/h';
              const liveStatus = isLive ? 'LIVE' : 'OFFLINE';
              const statusColor = isLive ? 'var(--success)' : 'var(--danger)';
              speedEl.innerHTML = `Speed: ${speedKmh} km/h <span style="color: ${statusColor}; font-weight: bold;">‚Ä¢ ${liveStatus}</span>`;

              distEl.innerHTML = `Distance: ${lastDriverPos ? calculateDistance(lastDriverPos.lat, lastDriverPos.lng, lat, lng).toFixed(3) : '0.000'} km <small style="color: var(--gray-light);">(${timeDiff < 1000 ? 'Just now' : Math.floor(timeDiff/1000)+'s ago'})</small>`;

              lastDriverPos = { lat, lng, ts: data.timestamp || now };
            } catch (err) {
              console.error('Polling error:', err);
            }
          }, 1500);
        }).catch(e=>{ console.error(e); showNotification('‚ùå Map failed', 'error'); });

        // start watching user's location (Android-friendly)
        if (navigator.geolocation && !userWatchId) {
          userWatchId = navigator.geolocation.watchPosition((p)=>{
            // optional: show user's own position on tracker map
            // add a small blue dot if not present
            try {
              if (map) {
                if (!map._userDot) {
                  map._userDot = L.circleMarker([p.coords.latitude, p.coords.longitude], { radius:6, color:'#1e90ff', fillColor:'#1e90ff', fillOpacity:1 }).addTo(map);
                } else {
                  map._userDot.setLatLng([p.coords.latitude, p.coords.longitude]);
                }
              }
            } catch(e){console.warn(e)}
          }, (err)=>{ console.warn('watch pos error', err); }, { enableHighAccuracy:true, maximumAge:2000, timeout:8000 });
        }
      }

      // Toggle marker label visibility
      if (toggleLabelBtn) {
        toggleLabelBtn.addEventListener('click', ()=>{
          if (!marker) return;
          const el = marker.getElement && marker.getElement();
          if (!el) return;
          const has = el.classList.toggle('show-label');
          toggleLabelBtn.textContent = has ? 'Hide Label' : 'Show Label';
        });
      }
      // Offer driver to start tracking self from tracker modal when applicable
      if (trackerSelfTrackBtn) {
        // show button only if current user exists and is same as bus being tracked
        const updateSelfTrackVisibility = () => {
          // allow any logged-in user (driver or admin) to start tracking themselves
          if (currentUser && currentUser.uid) {
            trackerSelfTrackBtn.style.display = 'inline-flex';
          } else {
            trackerSelfTrackBtn.style.display = 'none';
          }
        };
        updateSelfTrackVisibility();

        trackerSelfTrackBtn.addEventListener('click', async ()=>{
          if (!currentUser) { showNotification('‚ùå Login required', 'error'); return; }
          // Start GPS updates for current user
          try {
            await requestLocationPermission();
            startGPSUpdates();
            showNotification('‚úÖ Your GPS tracking started', 'success');
            updateSelfTrackVisibility();
          } catch(e){ console.error(e); showNotification('‚ùå Failed to start GPS', 'error'); }
        });
      }

      function closeTracker() {
        modal.style.display = 'none';
        currentBusId = null;
        removeBusListener();
        if (marker) { try { map.removeLayer(marker); } catch(e){} marker=null; }
        if (beam) { try { map.removeLayer(beam); } catch(e){} beam=null; }
        if (userWatchId) { navigator.geolocation.clearWatch(userWatchId); userWatchId=null; }
        // reset auto-center state for next open
        autoCenterDone = false;
        userMovedMap = false;
      }

      function getColorForString(s) {
        let h=0; for (let i=0;i<s.length;i++) h = s.charCodeAt(i) + ((h<<5)-h);
        const c = Math.abs(h)%360; return `hsl(${c} 70% 55%)`;
      }

      // Smoothly move marker from its current position to target over duration (ms)
      function smoothMoveMarker(mkr, target, duration=700) {
        if (!mkr || !map) return;
        const start = mkr.getLatLng();
        const end = L.latLng(target.lat, target.lng);
        const startTime = performance.now();

        function step(now) {
          const t = Math.min(1, (now - startTime) / duration);
          const lat = start.lat + (end.lat - start.lat) * t;
          const lng = start.lng + (end.lng - start.lng) * t;
          mkr.setLatLng([lat, lng]);
          if (t < 1) requestAnimationFrame(step);
        }

        requestAnimationFrame(step);
      }

      // Center/Home behavior
      centerBtn.addEventListener('click', ()=>{ if (map && marker) map.panTo(marker.getLatLng()); });
      homeBtn.addEventListener('click', ()=>{ closeTracker(); window.scrollTo({top:0,behavior:'smooth'}); });
      closeBtn.addEventListener('click', closeTracker);
      
      // Home Close Center button functionality
      homeCloseCenterBtn.addEventListener('click', ()=>{
        if (map && marker) {
          map.panTo(marker.getLatLng());
          setTimeout(() => {
            closeTracker();
            window.scrollTo({top:0,behavior:'smooth'});
          }, 500);
        } else {
          closeTracker();
          window.scrollTo({top:0,behavior:'smooth'});
        }
      });

      // Delegate Track click: open tracker
      document.addEventListener('click', function(e){
        const btn = e.target.closest('.track-btn'); if (!btn) return;
        const busId = btn.getAttribute('data-bus-id'); const driverName = btn.getAttribute('data-driver-name')||'';
        if (!busId) { showNotification('‚ùå Missing bus id','error'); return; }
        openTrackerFor(busId, driverName);
      });

      // Delegate Stop click: stop bus tracking
      document.addEventListener('click', function(e){
        const btn = e.target.closest('.stop-btn'); if (!btn) return;
        const busId = btn.getAttribute('data-bus-id'); const driverName = btn.getAttribute('data-driver-name')||'';
        if (!busId) { showNotification('‚ùå Missing bus id','error'); return; }
        stopBusTracking(busId, driverName);
      });
    })();

    // Stop bus tracking function
    window.stopBusTracking = async function(busId, driverName) {
      if (!confirm(`Are you sure you want to stop tracking for ${driverName}?`)) return;

      try {
        // Remove from RTDB
        const locRef = dbRef(rtdb, `locations/${busId}`);
        await remove(locRef);
        
        showNotification(`‚èπÔ∏è Stopped tracking for ${driverName}`, 'success');
        
        // Update UI immediately
        handleBusStopped(busId);
        
        // If it's the current user's own bus, also stop their GPS
        if (currentUser && busId === currentUser.uid && gpsInterval) {
          stopGPSUpdates();
        }
        
      } catch (error) {
        console.error('Error stopping bus tracking:', error);
        showNotification('‚ùå Failed to stop tracking', 'error');
      }
    };

    // Remove bus from list when RTDB node removed
    function handleBusStopped(busId) {
      // remove from allBusesData and re-render
      allBusesData = Array.isArray(allBusesData) ? allBusesData.filter(b => (b.id || b.uid) !== busId) : [];
      // re-render current view
      if (document.getElementById('busListTitle').textContent === 'Live Buses') watchLiveBuses();
      else renderBusList(allBusesData, true);
    }
  </script>

<!--  embed code: Paste this in your other web page's <body>. Changes: New logo GIF in button (fetched via direct img src for proper display; iframe not needed as it's a static GIF). Button hides when modal opens, shows on close. Modal close handled via iframe's postMessage or manual close. -->
<busmarg-ai src="https://aiassistant-61c65.web.app" style="display: none;"></busmarg-ai>
<script>
class BusMargAI extends HTMLElement {
connectedCallback() {
const src = this.getAttribute('src');
const btn = document.createElement('div');
btn.innerHTML = `<img src="https://mir-s3-cdn-cf.behance.net/project_modules/source/524820111444627.6001ca53344af.gif" style="width:24px;height:24px;border-radius:50%;margin-right:8px;"><span>Assistant</span><div style="margin-left:8px;">üìû</div>`;
btn.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#000;color:#fff;padding:12px 16px;border-radius:25px;display:flex;align-items:center;gap:4px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:10000;font-weight:600;font-size:14px;transition:transform 0.2s ease;';
btn.onmouseover = () => { btn.style.transform = 'scale(1.05)'; };
btn.onmouseout = () => { btn.style.transform = 'scale(1)'; };
btn.onclick = () => { window.location.href = src; };
document.body.appendChild(btn);
}
}
customElements.define('busmarg-ai', BusMargAI);
</script>

<script>
  const interval = setInterval(() => {
    const viewer = document.querySelector('spline-viewer');
    if (viewer && viewer.shadowRoot) {
      const logo = viewer.shadowRoot.querySelector('#logo');
      if (logo) {
        logo.remove();
        console.log("Logo removed!");
        clearInterval(interval);
      }
    }
  }, 500);
</script>

</body>
</html>